<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#FFC107">
  
  <!-- ğŸ” SECURITY HEADERS -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://unpkg.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' data: blob: https:;
    connect-src 'self' https://generativelanguage.googleapis.com https://api.openai.com https://api.stability.ai;
    frame-ancestors 'none';
    form-action 'self';
    base-uri 'self';
    object-src 'none';
  ">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=()">
  <!-- Prevent caching of admin pages -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø§Ù„Ø²ÙŠÙ† Ù„Ù„Ù…ÙØ±ÙˆØ´Ø§Øª</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
  
  <!-- Security Check - Must be at the top -->
  <script>
    // Check session before page loads
    (function() {
      const session = localStorage.getItem('alzain_admin_session');
      const expiry = localStorage.getItem('alzain_session_expiry');
      
      if (!session || !expiry || Date.now() > parseInt(expiry)) {
        // Session expired or doesn't exist
        localStorage.removeItem('alzain_admin_session');
        localStorage.removeItem('alzain_session_expiry');
        window.location.href = 'login.html';
        return;
      }
      
      // Extend session on activity
      const newExpiry = Date.now() + (30 * 60 * 1000); // 30 minutes
      localStorage.setItem('alzain_session_expiry', newExpiry);
    })();
  </script>
  
  <style>
    body { font-family: 'Tajawal', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); }
    .gold-gradient { background: linear-gradient(135deg, #FFC107, #FFD54F); }
    .card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(0, 0, 0, 0.08); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: -280px;
        top: 0;
        height: 100vh;
        z-index: 1000;
        transition: left 0.3s ease;
        width: 280px !important;
      }
      
      .sidebar.mobile-open {
        left: 0;
      }
      
      .sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }
      
      .sidebar-overlay.active {
        display: block;
      }
      
      .main-content {
        margin-right: 0 !important;
        width: 100% !important;
      }
      
      .mobile-menu-btn {
        display: flex !important;
      }
      
      /* Cards responsive */
      .grid.grid-cols-4 {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
      }
      
      .card {
        padding: 16px !important;
      }
      
      .card h3 {
        font-size: 0.875rem !important;
      }
      
      /* Tabs responsive */
      .flex.gap-2 button {
        padding: 8px 12px !important;
        font-size: 0.75rem !important;
      }
      
      /* Table responsive */
      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      
      /* Form inputs */
      input, select, textarea {
        font-size: 16px !important; /* Prevents iOS zoom */
      }
      
      /* Buttons */
      button {
        min-height: 44px;
      }
    }
    
    @media (max-width: 480px) {
      .grid.grid-cols-4 {
        grid-template-columns: 1fr !important;
      }
      
      h2 {
        font-size: 1.25rem !important;
      }
      
      .p-6 {
        padding: 16px !important;
      }
    }
    
    /* Touch device optimizations */
    @media (hover: none) and (pointer: coarse) {
      button, a, input, select {
        min-height: 44px;
      }
    }
    
    /* Safe area for notched phones */
    @supports (padding: max(0px)) {
      .sidebar {
        padding-top: max(20px, env(safe-area-inset-top));
        padding-bottom: max(20px, env(safe-area-inset-bottom));
      }
    }
    
    /* Better tap highlight */
    button, a {
      -webkit-tap-highlight-color: transparent;
    }
    
    /* Mobile menu button (hidden by default on desktop) */
    .mobile-menu-btn {
      display: none;
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 998;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #FFC107, #FFD54F);
      border: none;
      border-radius: 12px;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4);
    }
  </style>

  <!-- Meta Pixel Code - Ultra Professional Admin Tracking -->
  <script>
    // =====================================================
    // META PIXEL PROFESSIONAL CONFIGURATION FOR ADMIN PANEL
    // =====================================================
    
    // Load Pixel ID from localStorage
    var metaPixelId = localStorage.getItem('alzain_meta_pixel_id') || '';
    var metaPixelDeactivated = localStorage.getItem('alzain_meta_pixel_deactivated') === 'true';
    var metaPixelLoaded = false;
    var metaPixelError = null;
    
    // Session tracking for accurate analytics
    var pixelAdminSessionId = 'admin_session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    var pixelAdminPageLoadTime = new Date().toISOString();
    var pixelAdminEventsLog = [];
    
    // Get or create unique admin user ID
    var pixelAdminUserId = localStorage.getItem('alzain_admin_user_id');
    if (!pixelAdminUserId) {
      pixelAdminUserId = 'admin_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('alzain_admin_user_id', pixelAdminUserId);
    }
    
    // Track admin login count
    var adminLoginCount = parseInt(localStorage.getItem('alzain_admin_login_count') || '0') + 1;
    localStorage.setItem('alzain_admin_login_count', adminLoginCount.toString());
    
    // Device and browser detection
    var pixelAdminDeviceInfo = {
      userAgent: navigator.userAgent,
      language: navigator.language,
      platform: navigator.platform,
      screenWidth: screen.width,
      screenHeight: screen.height,
      viewportWidth: window.innerWidth,
      viewportHeight: window.innerHeight,
      devicePixelRatio: window.devicePixelRatio || 1,
      touchSupport: 'ontouchstart' in window,
      cookiesEnabled: navigator.cookieEnabled,
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      referrer: document.referrer || 'direct'
    };
    
    // Detect device type
    function getAdminDeviceType() {
      var ua = navigator.userAgent;
      if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) return 'tablet';
      if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(ua)) return 'mobile';
      return 'desktop';
    }
    pixelAdminDeviceInfo.deviceType = getAdminDeviceType();
    
    if (metaPixelId && !metaPixelDeactivated) {
      console.log('ğŸ”µ Admin Meta Pixel: Loading with ID:', metaPixelId);
      console.log('ğŸ”µ Admin Session ID:', pixelAdminSessionId);
      console.log('ğŸ”µ Admin User ID:', pixelAdminUserId);
      console.log('ğŸ”µ Admin Login #:', adminLoginCount);
      
      try {
        !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;
        t.onload = function() {
          metaPixelLoaded = true;
          console.log('âœ… Admin Meta Pixel: Script loaded successfully');
        };
        t.onerror = function() {
          metaPixelError = 'Failed to load Facebook SDK';
          console.error('âŒ Admin Meta Pixel: Failed to load script');
        };
        s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        
        // Initialize with advanced matching
        fbq('init', metaPixelId);
        
        // Track PageView with admin context
        fbq('track', 'PageView', {
          content_name: 'Admin Panel - ' + document.title,
          content_category: 'admin',
          page_url: window.location.href,
          referrer: document.referrer || 'direct'
        });
        
        console.log('âœ… Admin Meta Pixel: Initialized and PageView tracked');
      } catch (e) {
        metaPixelError = e.message;
        console.error('âŒ Admin Meta Pixel Error:', e);
      }
    } else if (metaPixelDeactivated) {
      console.log('â¸ï¸ Admin Meta Pixel: Deactivated by user');
    } else {
      console.log('âš ï¸ Admin Meta Pixel: No Pixel ID configured');
    }
    
    // =====================================================
    // PROFESSIONAL ADMIN EVENT TRACKING FUNCTIONS
    // =====================================================
    
    // Generate unique event ID for deduplication
    function generateAdminEventId() {
      return 'admin_evt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    // Log admin event for analytics
    function logAdminPixelEvent(eventName, params, eventId) {
      var eventLog = {
        event_id: eventId,
        event_name: eventName,
        timestamp: new Date().toISOString(),
        params: params,
        session_id: pixelAdminSessionId,
        admin_user_id: pixelAdminUserId
      };
      pixelAdminEventsLog.push(eventLog);
      
      // Store last 100 admin events in localStorage for debugging
      var storedEvents = JSON.parse(localStorage.getItem('alzain_admin_pixel_events') || '[]');
      storedEvents.push(eventLog);
      if (storedEvents.length > 100) storedEvents = storedEvents.slice(-100);
      localStorage.setItem('alzain_admin_pixel_events', JSON.stringify(storedEvents));
    }
    
    // Main admin tracking function with professional parameters
    function trackAdminPixelEvent(eventName, params) {
      // Check if deactivated
      if (metaPixelDeactivated) {
        console.log('â¸ï¸ Admin Meta Pixel: Event skipped (deactivated):', eventName);
        return false;
      }
      
      if (typeof fbq !== 'undefined' && metaPixelId) {
        try {
          // Generate unique event ID for deduplication
          var eventId = generateAdminEventId();
          
          // Enrich parameters with professional admin data
          var enrichedParams = Object.assign({}, params || {}, {
            event_id: eventId,
            event_time: Math.floor(Date.now() / 1000),
            event_source_url: window.location.href,
            action_source: 'website',
            user_agent: navigator.userAgent,
            
            // Custom admin data
            custom_data: {
              session_id: pixelAdminSessionId,
              admin_user_id: pixelAdminUserId,
              admin_login_count: adminLoginCount,
              device_type: pixelAdminDeviceInfo.deviceType,
              viewport: pixelAdminDeviceInfo.viewportWidth + 'x' + pixelAdminDeviceInfo.viewportHeight,
              referrer: pixelAdminDeviceInfo.referrer,
              page_title: document.title,
              timestamp_iso: new Date().toISOString(),
              context: 'admin_panel'
            }
          });
          
          // Track with Facebook
          fbq('track', eventName, enrichedParams, { eventID: eventId });
          
          // Log event
          logAdminPixelEvent(eventName, enrichedParams, eventId);
          
          console.log('âœ… Admin Meta Pixel Event:', eventName, enrichedParams);
          return true;
        } catch (e) {
          console.error('âŒ Admin Meta Pixel Event Error:', e);
          return false;
        }
      } else {
        if (!metaPixelId) {
          console.log('âš ï¸ Admin Meta Pixel: Skipping event (no Pixel ID):', eventName);
        }
        return false;
      }
    }
    
    // =====================================================
    // SPECIALIZED ADMIN TRACKING FUNCTIONS
    // =====================================================
    
    // Track admin login
    function trackAdminLogin(username) {
      return trackAdminPixelEvent('CustomEvent', {
        event_name: 'admin_login',
        content_name: 'Admin Panel Login',
        content_category: 'admin_action',
        username: username || 'unknown'
      });
    }
    
    // Track product actions
    function trackAdminProductAction(action, productData) {
      return trackAdminPixelEvent('CustomEvent', {
        event_name: 'admin_product_' + action,
        content_name: productData.name || 'Unknown Product',
        content_category: 'admin_product_management',
        action: action, // add, edit, delete
        product_id: productData.id || 'new',
        product_category: productData.collection || 'unknown'
      });
    }
    
    // Track order actions
    function trackAdminOrderAction(action, orderData) {
      return trackAdminPixelEvent('CustomEvent', {
        event_name: 'admin_order_' + action,
        content_name: 'Order: ' + (orderData.productName || 'Unknown'),
        content_category: 'admin_order_management',
        action: action, // view, update_status, delete
        order_id: orderData.id || 'unknown',
        order_status: orderData.status || 'unknown',
        value: parseFloat(orderData.totalPrice) || 0,
        currency: 'IQD'
      });
    }
    
    // Track settings changes
    function trackAdminSettingsChange(settingType, settingValue) {
      return trackAdminPixelEvent('CustomEvent', {
        event_name: 'admin_settings_change',
        content_name: 'Settings: ' + settingType,
        content_category: 'admin_configuration',
        setting_type: settingType,
        setting_value: settingValue || 'updated'
      });
    }
    
    // Track data export/import
    function trackAdminDataAction(action) {
      return trackAdminPixelEvent('CustomEvent', {
        event_name: 'admin_data_' + action,
        content_name: 'Data ' + action.toUpperCase(),
        content_category: 'admin_data_management',
        action: action // export, import
      });
    }
    
    // Track time on admin panel
    var adminPageStartTime = Date.now();
    function trackAdminTimeOnPage() {
      var timeSpent = Math.round((Date.now() - adminPageStartTime) / 1000);
      trackAdminPixelEvent('CustomEvent', {
        event_name: 'admin_time_on_page',
        time_seconds: timeSpent,
        content_name: 'Admin Panel Session',
        content_category: 'admin_usage'
      });
    }
    
    // Add admin time tracking
    if (metaPixelId && !metaPixelDeactivated) {
      // Track time on page when leaving
      window.addEventListener('beforeunload', trackAdminTimeOnPage);
    }
    
    // =====================================================
    // ADMIN DEBUGGING AND STATUS FUNCTIONS
    // =====================================================
    
    // Function to check admin pixel status
    function checkAdminMetaPixelStatus() {
      return {
        pixelId: metaPixelId,
        deactivated: metaPixelDeactivated,
        loaded: metaPixelLoaded,
        fbqAvailable: typeof fbq !== 'undefined',
        error: metaPixelError,
        status: metaPixelDeactivated ? 'deactivated' : (metaPixelId ? (typeof fbq !== 'undefined' ? 'active' : 'loading') : 'not_configured'),
        sessionId: pixelAdminSessionId,
        adminUserId: pixelAdminUserId,
        adminLoginCount: adminLoginCount,
        deviceInfo: pixelAdminDeviceInfo,
        eventsTracked: pixelAdminEventsLog.length,
        recentEvents: pixelAdminEventsLog.slice(-10)
      };
    }
    
    // Get all admin tracked events
    function getAdminPixelEvents() {
      return JSON.parse(localStorage.getItem('alzain_admin_pixel_events') || '[]');
    }
    
    // Clear admin event history
    function clearAdminPixelEvents() {
      localStorage.removeItem('alzain_admin_pixel_events');
      pixelAdminEventsLog = [];
      console.log('âœ… Admin pixel events cleared');
    }
    
    // Expose to window for debugging
    window.checkAdminMetaPixelStatus = checkAdminMetaPixelStatus;
    window.getAdminPixelEvents = getAdminPixelEvents;
    window.clearAdminPixelEvents = clearAdminPixelEvents;
  </script>
</head>
<body class="gradient-bg min-h-screen">

  <!-- Mobile Menu Button -->
  <button class="mobile-menu-btn" onclick="toggleMobileSidebar()">
    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
    </svg>
  </button>
  
  <!-- Mobile Sidebar Overlay -->
  <div class="sidebar-overlay" onclick="closeMobileSidebar()"></div>
  
  <!-- Login Screen -->
  <div id="loginScreen" class="hidden min-h-screen flex items-center justify-center p-6">
    <div class="max-w-md w-full">
      <!-- Logo -->
      <div class="text-center mb-8">
        <div class="inline-block p-6 rounded-3xl bg-gradient-to-br from-amber-500/20 to-amber-600/10 backdrop-blur-xl border-2 border-amber-500/30 mb-4">
          <h1 class="text-5xl font-black gold-gradient bg-clip-text text-transparent">Ø§Ù„Ø²ÙŠÙ†</h1>
        </div>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
        <p class="text-gray-600">Ù…ØµÙ†Ø¹ Ø§Ù„Ø²ÙŠÙ† Ù„Ù„Ù…ÙØ±ÙˆØ´Ø§Øª</p>
      </div>

      <!-- Login Form -->
      <div class="card rounded-3xl p-8 shadow-2xl">
        <form id="loginForm" class="space-y-6">
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
            <input type="text" id="username" required
              class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 placeholder-gray-400 focus:outline-none focus:border-amber-500 transition">
          </div>

          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input type="password" id="password" required
              class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 placeholder-gray-400 focus:outline-none focus:border-amber-500 transition">
          </div>

          <div id="error" class="hidden bg-red-500/20 border border-red-500 text-red-200 px-4 py-3 rounded-xl text-sm"></div>

          <button type="submit" class="w-full gold-gradient text-black font-black py-4 rounded-xl text-lg hover:shadow-lg hover:shadow-amber-500/50 transition transform hover:scale-105">
            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
          </button>
        </form>

        <p class="text-center text-sm text-gray-600 mt-6">
          Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: <strong class="text-amber-600">admin</strong> / <strong class="text-amber-600">admin123</strong>
        </p>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboardScreen">
    <!-- Header -->
    <nav class="bg-white/95 backdrop-blur-xl border-b border-gray-200 p-4 shadow-sm">
      <div class="container mx-auto flex justify-between items-center">
        <div class="flex items-center gap-4">
          <div class="gold-gradient bg-clip-text text-transparent text-3xl font-black">Ø§Ù„Ø²ÙŠÙ†</div>
          <div class="text-gray-400">|</div>
          <h1 class="text-xl font-bold text-gray-900">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
        </div>
        <div class="flex items-center gap-4">
          <span class="text-gray-700" id="welcomeUser"></span>
          <span class="text-xs text-gray-500" id="lastRefresh">ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ...</span>
          <button onclick="exportData()" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl hover:bg-blue-100 transition font-bold flex items-center gap-2" title="ØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          </button>
          <button onclick="document.getElementById('importFile').click()" class="bg-green-50 text-green-600 px-4 py-2 rounded-xl hover:bg-green-100 transition font-bold flex items-center gap-2" title="Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ù…Ù„Ù">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><polyline points="9 15 12 18 15 15"/></svg>
            Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          </button>
          <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
          <button onclick="logout()" class="bg-red-50 text-red-600 px-4 py-2 rounded-xl hover:bg-red-100 transition flex items-center gap-2">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
          </button>
        </div>
      </div>
    </nav>

    <div class="container mx-auto p-6">
      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
        <div class="card rounded-3xl p-6">
          <div class="text-gray-600 text-sm mb-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
          <div class="text-4xl font-black text-gray-900" id="totalProducts">2</div>
        </div>
        <div class="card rounded-3xl p-6">
          <div class="text-gray-600 text-sm mb-2">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</div>
          <div class="text-4xl font-black gold-gradient bg-clip-text text-transparent" id="newOrders">0</div>
        </div>
        <div class="card rounded-3xl p-6">
          <div class="text-gray-600 text-sm mb-2">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</div>
          <div class="text-4xl font-black text-blue-600" id="processingOrders">0</div>
        </div>
        <div class="card rounded-3xl p-6">
          <div class="text-gray-600 text-sm mb-2">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div>
          <div class="text-4xl font-black text-green-600" id="completedOrders">0</div>
        </div>
        <div class="card rounded-3xl p-6" title="Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©">
          <div class="text-gray-600 text-sm mb-2">Ø§Ù„ØªØ®Ø²ÙŠÙ†</div>
          <div class="text-2xl font-black text-gray-900" id="storageUsage">--</div>
          <div class="text-xs text-gray-500 mt-1" id="storagePercent">Ø­Ø³Ø§Ø¨...</div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="flex gap-4 mb-6">
        <button onclick="showTab('products')" id="productsTab" class="px-6 py-3 rounded-xl font-bold gold-gradient text-black flex items-center gap-2">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
          Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        </button>
        <button onclick="showTab('orders')" id="ordersTab" class="px-6 py-3 rounded-xl font-bold bg-gray-100 text-gray-700 hover:bg-gray-200 transition flex items-center gap-2">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
          Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        </button>
        <button onclick="showTab('recycle')" id="recycleTab" class="px-6 py-3 rounded-xl font-bold bg-gray-100 text-gray-700 hover:bg-gray-200 transition flex items-center gap-2">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
          Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
        </button>
        <button onclick="showTab('settings')" id="settingsTab" class="px-6 py-3 rounded-xl font-bold bg-gray-100 text-gray-700 hover:bg-gray-200 transition flex items-center gap-2">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
          Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        </button>
        <button onclick="showTab('ai')" id="aiTab" class="px-6 py-3 rounded-xl font-bold bg-gray-100 text-gray-700 hover:bg-gray-200 transition flex items-center gap-2" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1));">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="url(#aiGradient)" stroke-width="2">
            <defs><linearGradient id="aiGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#8B5CF6"/><stop offset="100%" stop-color="#EC4899"/></linearGradient></defs>
            <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke="#8B5CF6"/>
          </svg>
          <span style="background: linear-gradient(135deg, #8B5CF6, #EC4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold;">Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</span>
        </button>
      </div>

      <!-- Products Tab -->
      <div id="productsContent" class="space-y-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-gray-900">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
          <button onclick="showAddProduct()" class="gold-gradient text-black font-bold px-6 py-3 rounded-xl hover:shadow-lg transition flex items-center gap-2">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
          </button>
        </div>
        
        <!-- Product Filter Tabs -->
        <div class="flex gap-3 mb-4">
          <button onclick="filterProducts('all')" id="filterAll" class="px-4 py-2 rounded-lg font-bold bg-gray-900 text-white">
            Ø§Ù„ÙƒÙ„ (<span id="countAll">0</span>)
          </button>
          <button onclick="filterProducts('active')" id="filterActive" class="px-4 py-2 rounded-lg font-bold bg-gray-100 text-gray-700 hover:bg-gray-200 transition">
            Ù†Ø´Ø· (<span id="countActive">0</span>)
          </button>
          <button onclick="filterProducts('inactive')" id="filterInactive" class="px-4 py-2 rounded-lg font-bold bg-gray-100 text-gray-700 hover:bg-gray-200 transition">
            ØºÙŠØ± Ù†Ø´Ø· (<span id="countInactive">0</span>)
          </button>
        </div>

        <div id="productsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Products will be loaded here -->
        </div>
      </div>

      <!-- Orders Tab -->
      <div id="ordersContent" class="hidden space-y-6">
        <h2 class="text-2xl font-bold text-gray-900">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
        <div id="ordersList" class="space-y-4">
          <!-- Orders will be loaded here -->
        </div>
      </div>

      <!-- Recycle Bin Tab -->
      <div id="recycleContent" class="hidden space-y-6">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
            Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
          </h2>
          <button onclick="emptyRecycleBin()" class="bg-red-600 text-white font-bold px-6 py-3 rounded-xl hover:bg-red-700 transition flex items-center gap-2">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
            Ø¥ÙØ±Ø§Øº Ø§Ù„Ø³Ù„Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
          </button>
        </div>
        <div id="recycleList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Deleted products will be loaded here -->
        </div>
      </div>

      <!-- Settings Tab -->
      <div id="settingsContent" class="hidden space-y-6">
        <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
          Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        </h2>
        
        <!-- Meta Pixel Settings -->
        <div class="card rounded-2xl p-6">
          <div class="flex items-center gap-3 mb-4">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#1877F2" stroke-width="2">
              <path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/>
            </svg>
            <div>
              <h3 class="text-xl font-bold text-gray-900">Meta Pixel (Facebook)</h3>
              <p class="text-sm text-gray-500">ØªØªØ¨Ø¹ Ø§Ù„Ø²ÙˆØ§Ø± ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙÙŠØ³Ø¨ÙˆÙƒ</p>
            </div>
          </div>
          
          <!-- Input Method Toggle -->
          <div class="flex gap-2 mb-4">
            <button onclick="togglePixelInputMethod('id')" id="pixelMethodId" class="px-4 py-2 rounded-lg font-bold bg-gray-900 text-white text-sm">
              Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ÙÙ‚Ø·
            </button>
            <button onclick="togglePixelInputMethod('code')" id="pixelMethodCode" class="px-4 py-2 rounded-lg font-bold bg-gray-100 text-gray-700 hover:bg-gray-200 transition text-sm">
              Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙƒØ§Ù…Ù„
            </button>
          </div>
          
          <div class="space-y-4">
            <!-- Pixel ID Input -->
            <div id="pixelIdInput">
              <label class="block text-sm font-bold text-gray-700 mb-2">Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¨ÙƒØ³Ù„ (Pixel ID)</label>
              <input type="text" id="metaPixelId" placeholder="Ù…Ø«Ø§Ù„: 1776784516229571" 
                     class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 text-left" dir="ltr">
              <p class="text-xs text-gray-500 mt-1">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨ÙƒØ³Ù„ Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 15-16 Ø±Ù‚Ù…</p>
            </div>
            
            <!-- Full Code Input -->
            <div id="pixelCodeInput" class="hidden">
              <label class="block text-sm font-bold text-gray-700 mb-2">ÙƒÙˆØ¯ Ø§Ù„Ø¨ÙƒØ³Ù„ Ø§Ù„ÙƒØ§Ù…Ù„</label>
              <textarea id="metaPixelCode" rows="8" placeholder="Ø§Ù„ØµÙ‚ ÙƒÙˆØ¯ Meta Pixel Ø§Ù„ÙƒØ§Ù…Ù„ Ù‡Ù†Ø§..."
                        class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 text-left font-mono text-xs" dir="ltr"></textarea>
              <p class="text-xs text-gray-500 mt-1">Ø§Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ ØªØ­ØµÙ„ Ø¹Ù„ÙŠÙ‡ Ù…Ù† ÙÙŠØ³Ø¨ÙˆÙƒ - Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
              <button onclick="extractPixelId()" class="mt-2 bg-gray-800 text-white font-bold px-4 py-2 rounded-lg hover:bg-gray-700 transition text-sm flex items-center gap-2">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8"/>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ù…Ù† Ø§Ù„ÙƒÙˆØ¯
              </button>
            </div>
            
            <!-- Extracted ID Display -->
            <div id="extractedIdDisplay" class="hidden p-3 bg-green-50 border border-green-200 rounded-xl">
              <p class="text-sm text-green-800 flex items-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù: <strong id="extractedIdValue" class="font-mono"></strong>
              </p>
            </div>
            
            <div class="flex flex-wrap gap-4">
              <button onclick="saveMetaPixel()" class="gold-gradient text-black font-bold px-6 py-3 rounded-xl hover:shadow-lg transition flex items-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                  <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                  <polyline points="17 21 17 13 7 13 7 21"/>
                  <polyline points="7 3 7 8 15 8"/>
                </svg>
                Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
              </button>
              <button onclick="checkPixelHealth()" class="bg-green-600 text-white font-bold px-6 py-3 rounded-xl hover:bg-green-700 transition flex items-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                  <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„
              </button>
              <button onclick="testMetaPixel()" class="bg-blue-600 text-white font-bold px-6 py-3 rounded-xl hover:bg-blue-700 transition flex items-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
                ÙØªØ­ Ù…Ø¯ÙŠØ± Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
              </button>
            </div>
            
            <!-- Connection Health Status -->
            <div id="pixelHealthStatus" class="hidden p-4 rounded-xl border"></div>
            
            <div id="pixelStatus" class="hidden p-4 rounded-xl"></div>
          </div>
          
          <!-- Tracked Events Info -->
          <div class="mt-6 p-4 bg-gray-50 rounded-xl">
            <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="16" x2="12" y2="12"/>
                <line x1="12" y1="8" x2="12.01" y2="8"/>
              </svg>
              Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…ØªØªØ¨Ø¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹:
            </h4>
            <ul class="space-y-2 text-sm text-gray-600">
              <li class="flex items-center gap-2">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                <strong>PageView</strong> - Ø¹Ù†Ø¯ Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØ§Ù„Ø²Ø§Ø¦Ø±)
              </li>
              <li class="flex items-center gap-2">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                <strong>ViewContent</strong> - Ø¹Ù†Ø¯ Ù…Ø´Ø§Ù‡Ø¯Ø© Ù…Ù†ØªØ¬ (Ù…Ø¹ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„ÙØ¦Ø©)
              </li>
              <li class="flex items-center gap-2">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                <strong>InitiateCheckout</strong> - Ø¹Ù†Ø¯ ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø·Ù„Ø¨ (Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„ÙƒÙ…ÙŠØ©)
              </li>
              <li class="flex items-center gap-2">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                <strong>Purchase</strong> - Ø¹Ù†Ø¯ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ (Ù…Ø¹ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø·Ù„Ø¨ ÙˆØªÙØ§ØµÙŠÙ„ ÙƒØ§Ù…Ù„Ø©)
              </li>
              <li class="flex items-center gap-2">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                <strong>Lead</strong> - Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…ÙŠÙ„ Ù…Ø­ØªÙ…Ù„ (Ù…Ø¹ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨)
              </li>
              <li class="flex items-center gap-2">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                <strong>Scroll Depth</strong> - ØªØªØ¨Ø¹ Ø¹Ù…Ù‚ Ø§Ù„ØªÙ…Ø±ÙŠØ± (25%ØŒ 50%ØŒ 75%ØŒ 100%)
              </li>
              <li class="flex items-center gap-2">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                <strong>Time on Page</strong> - ÙˆÙ‚Øª Ø§Ù„Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
              </li>
            </ul>
            
            <div class="mt-4 p-3 bg-blue-50 rounded-lg">
              <h5 class="font-bold text-blue-800 text-sm mb-2">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©:</h5>
              <ul class="text-xs text-blue-700 space-y-1">
                <li>â€¢ Ù…Ø¹Ø±Ù‘Ù Ø¬Ù„Ø³Ø© ÙØ±ÙŠØ¯ Ù„ÙƒÙ„ Ø²ÙŠØ§Ø±Ø©</li>
                <li>â€¢ Ù…Ø¹Ø±Ù‘Ù Ø²Ø§Ø¦Ø± Ø¯Ø§Ø¦Ù… Ù„Ù„ØªØªØ¨Ø¹ Ø¹Ø¨Ø± Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</li>
                <li>â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ø²Ø§Ø¦Ø±</li>
                <li>â€¢ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø² (Ù‡Ø§ØªÙ/ØªØ§Ø¨Ù„Øª/ÙƒÙ…Ø¨ÙŠÙˆØªØ±)</li>
                <li>â€¢ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØ§Ù„Ù…ØªØµÙØ­</li>
                <li>â€¢ Ù…ØµØ¯Ø± Ø§Ù„Ø¥Ø­Ø§Ù„Ø© (Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø³Ø§Ø¨Ù‚)</li>
                <li>â€¢ Ù…Ø¹Ø±Ù‘Ù ÙØ±ÙŠØ¯ Ù„ÙƒÙ„ Ø­Ø¯Ø« (Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±)</li>
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Help Link -->
        <div class="card rounded-2xl p-6">
          <h3 class="text-lg font-bold text-gray-900 mb-3">ÙƒÙŠÙÙŠØ© Ø¥Ø¹Ø¯Ø§Ø¯ Meta Pixel</h3>
          <ol class="list-decimal list-inside space-y-2 text-sm text-gray-600">
            <li>Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ <a href="https://business.facebook.com/events_manager" target="_blank" class="text-blue-600 underline">Ù…Ø¯ÙŠØ± Ø£Ø­Ø¯Ø§Ø« ÙÙŠØ³Ø¨ÙˆÙƒ</a></li>
            <li>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø±Ø¨Ø· Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" Ø«Ù… "Ø§Ù„ÙˆÙŠØ¨"</li>
            <li>Ø§Ø®ØªØ± "Meta Pixel" ÙˆØ§ØªØ¨Ø¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª</li>
            <li>Ø§Ù†Ø³Ø® Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¨ÙƒØ³Ù„ (Ø±Ù‚Ù… Ù…ÙƒÙˆÙ† Ù…Ù† 15-16 Ø±Ù‚Ù…)</li>
            <li>Ø§Ù„ØµÙ‚Ù‡ Ù‡Ù†Ø§ ÙˆØ§Ø¶ØºØ· "Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"</li>
          </ol>
        </div>
        
        <!-- Security Settings - Password Change -->
        <div class="card rounded-2xl p-6">
          <div class="flex items-center gap-3 mb-4">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
              <path d="M7 11V7a5 5 0 0110 0v4"/>
            </svg>
            <div>
              <h3 class="text-xl font-bold text-gray-900">Ø§Ù„Ø£Ù…Ø§Ù† ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
              <p class="text-sm text-gray-500">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</p>
            </div>
          </div>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
              <input type="password" id="currentPassword" 
                     class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900"
                     placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©">
            </div>
            
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
              <input type="password" id="newPassword" 
                     class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900"
                     placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)">
              <div id="passwordStrength" class="mt-2 hidden">
                <div class="flex gap-1">
                  <div class="h-1 flex-1 rounded bg-gray-200"></div>
                  <div class="h-1 flex-1 rounded bg-gray-200"></div>
                  <div class="h-1 flex-1 rounded bg-gray-200"></div>
                  <div class="h-1 flex-1 rounded bg-gray-200"></div>
                </div>
                <p id="passwordStrengthText" class="text-xs mt-1"></p>
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
              <input type="password" id="confirmPassword" 
                     class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900"
                     placeholder="Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
            </div>
            
            <div id="passwordChangeStatus" class="hidden p-3 rounded-xl text-sm text-center"></div>
            
            <div class="flex flex-wrap gap-4">
              <button onclick="changePassword()" class="bg-red-600 text-white font-bold px-6 py-3 rounded-xl hover:bg-red-700 transition flex items-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
                ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
              </button>
              <button onclick="logout()" class="bg-gray-600 text-white font-bold px-6 py-3 rounded-xl hover:bg-gray-700 transition flex items-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/>
                  <polyline points="16 17 21 12 16 7"/>
                  <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
              </button>
            </div>
            
            <div class="p-4 bg-blue-50 rounded-xl">
              <h5 class="font-bold text-blue-800 text-sm mb-2">ğŸ’¡ Ù†ØµØ§Ø¦Ø­ Ø§Ù„Ø£Ù…Ø§Ù†:</h5>
              <ul class="text-xs text-blue-700 space-y-1">
                <li>â€¢ Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ© (8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)</li>
                <li>â€¢ Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø²ÙŠØ¬ Ù…Ù† Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„ÙƒØ¨ÙŠØ±Ø© ÙˆØ§Ù„ØµØºÙŠØ±Ø© ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù…</li>
                <li>â€¢ Ù„Ø§ ØªØ´Ø§Ø±Ùƒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø¹ Ø£Ø­Ø¯</li>
                <li>â€¢ ØºÙŠÙ‘Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ</li>
                <li>â€¢ Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 30 Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„Ù†Ø´Ø§Ø·</li>
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Debug Console -->
        <div class="card rounded-2xl p-6">
          <h3 class="text-lg font-bold text-gray-900 mb-3 flex items-center gap-2">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="4 17 10 11 4 5"/>
              <line x1="12" y1="19" x2="20" y2="19"/>
            </svg>
            Ø£ÙˆØ§Ù…Ø± ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ… (Console)
          </h3>
          <p class="text-sm text-gray-600 mb-3">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø£ÙˆØ§Ù…Ø± ÙÙŠ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ… (F12) Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ù…Ù„ Ø§Ù„Ø¨ÙƒØ³Ù„:</p>
          <div class="space-y-2 font-mono text-xs bg-gray-900 text-green-400 p-4 rounded-lg">
            <p><span class="text-gray-500">// Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙƒØ³Ù„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</span></p>
            <p>checkMetaPixelStatus()</p>
            <p class="mt-3"><span class="text-gray-500">// Ø¹Ø±Ø¶ Ø¢Ø®Ø± Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹</span></p>
            <p>getPixelEvents()</p>
            <p class="mt-3"><span class="text-gray-500">// Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø¨ÙƒØ³Ù„ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span></p>
            <p>checkAdminMetaPixelStatus()</p>
            <p class="mt-3"><span class="text-gray-500">// Ø¹Ø±Ø¶ Ø£Ø­Ø¯Ø§Ø« Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span></p>
            <p>getAdminPixelEvents()</p>
          </div>
        </div>
        
        <!-- Analytics Dashboard -->
        <div class="card rounded-2xl p-6 mt-6">
          <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="20" x2="18" y2="10"/>
              <line x1="12" y1="20" x2="12" y2="4"/>
              <line x1="6" y1="20" x2="6" y2="14"/>
            </svg>
            Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
          </h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <!-- Main Site Analytics -->
            <div class="p-4 bg-blue-50 rounded-xl">
              <h4 class="font-bold text-blue-900 mb-3 flex items-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                  <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
              </h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-blue-700">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«:</span>
                  <strong id="mainSiteEventsCount" class="text-blue-900">0</strong>
                </div>
                <div class="flex justify-between">
                  <span class="text-blue-700">Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„ÙØ±ÙŠØ¯ÙˆÙ†:</span>
                  <strong id="mainSiteVisitors" class="text-blue-900">-</strong>
                </div>
                <div class="flex justify-between">
                  <span class="text-blue-700">Ø¢Ø®Ø± Ø­Ø¯Ø«:</span>
                  <strong id="mainSiteLastEvent" class="text-blue-900 text-xs">-</strong>
                </div>
              </div>
              <button onclick="refreshMainSiteAnalytics()" class="mt-3 w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm font-bold">
                ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
              </button>
            </div>
            
            <!-- Admin Panel Analytics -->
            <div class="p-4 bg-purple-50 rounded-xl">
              <h4 class="font-bold text-purple-900 mb-3 flex items-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <line x1="9" y1="3" x2="9" y2="21"/>
                </svg>
                Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
              </h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-purple-700">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«:</span>
                  <strong id="adminEventsCount" class="text-purple-900">0</strong>
                </div>
                <div class="flex justify-between">
                  <span class="text-purple-700">Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª:</span>
                  <strong id="adminLoginCount" class="text-purple-900">-</strong>
                </div>
                <div class="flex justify-between">
                  <span class="text-purple-700">Ø¢Ø®Ø± Ø­Ø¯Ø«:</span>
                  <strong id="adminLastEvent" class="text-purple-900 text-xs">-</strong>
                </div>
              </div>
              <button onclick="refreshAdminAnalytics()" class="mt-3 w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition text-sm font-bold">
                ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
              </button>
            </div>
          </div>
          
          <!-- Recent Events -->
          <div class="mt-4">
            <h4 class="font-bold text-gray-900 mb-3">Ø¢Ø®Ø± 10 Ø£Ø­Ø¯Ø§Ø«</h4>
            <div class="bg-gray-50 rounded-xl p-4 max-h-96 overflow-y-auto">
              <div id="recentEventsList" class="space-y-2 text-xs">
                <p class="text-gray-500 text-center py-4">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</p>
              </div>
            </div>
          </div>
          
          <!-- Export Analytics -->
          <div class="mt-4 flex gap-3">
            <button onclick="exportAnalyticsData()" class="flex-1 bg-green-600 text-white px-4 py-3 rounded-xl hover:bg-green-700 transition font-bold flex items-center justify-center gap-2">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØªØ¨Ø¹
            </button>
            <button onclick="clearAllAnalytics()" class="bg-red-600 text-white px-4 py-3 rounded-xl hover:bg-red-700 transition font-bold flex items-center gap-2">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
              </svg>
              Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- AI Tab -->
    <div id="aiContent" class="hidden space-y-6">
      <div class="flex items-center gap-4 mb-6">
        <div class="w-14 h-14 rounded-2xl flex items-center justify-center" style="background: linear-gradient(135deg, #8B5CF6, #EC4899);">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
          </svg>
        </div>
        <div>
          <h2 class="text-2xl font-bold" style="background: linear-gradient(135deg, #8B5CF6, #EC4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h2>
          <p class="text-gray-500">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø®Ø¯Ù…Ø© AI Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£Ø«Ø§Ø«</p>
        </div>
      </div>

      <!-- API Configuration Card -->
      <div class="card rounded-2xl p-6">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-purple-100">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8B5CF6" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
              <path d="M7 11V7a5 5 0 0110 0v4"/>
            </svg>
          </div>
          <div>
            <h3 class="text-lg font-bold text-gray-900">Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙØªØ§Ø­ API</h3>
            <p class="text-sm text-gray-500">Ø§ØªØµØ§Ù„ Ø®Ø¯Ù…Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
          </div>
        </div>
          
          <!-- API Key Input -->
          <div class="mb-6">
            <label class="block text-sm font-bold text-gray-700 mb-2">Ù…ÙØªØ§Ø­ API Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</label>
            <div class="flex gap-2">
              <input type="password" id="aiApiKey" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxx" 
                     class="flex-1 px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 text-left font-mono" dir="ltr">
              <button onclick="toggleAiKeyVisibility()" class="bg-gray-100 px-4 py-3 rounded-xl hover:bg-gray-200 transition" id="toggleAiKeyBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
              </button>
            </div>
            <p class="text-xs text-gray-500 mt-1">Ù…ÙØªØ§Ø­ API Ù…Ù† OpenAI Ø£Ùˆ Stability AI Ø£Ùˆ Ø£ÙŠ Ø®Ø¯Ù…Ø© AI Ø£Ø®Ø±Ù‰</p>
            
            <div class="flex gap-3 mt-4">
              <button onclick="saveAiApiKey()" class="gold-gradient text-black font-bold px-6 py-3 rounded-xl hover:shadow-lg transition flex items-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                  <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                  <polyline points="17 21 17 13 7 13 7 21"/>
                  <polyline points="7 3 7 8 15 8"/>
                </svg>
                Ø­ÙØ¸ Ø§Ù„Ù…ÙØªØ§Ø­
              </button>
              <button onclick="testAiConnection()" class="bg-purple-600 text-white font-bold px-6 py-3 rounded-xl hover:bg-purple-700 transition flex items-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                  <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
              </button>
            </div>
            
            <div id="aiApiStatus" class="hidden mt-3 p-4 rounded-xl"></div>
          </div>
          
          <!-- AI Usage Statistics -->
          <div class="border-t border-gray-200 pt-6">
            <h4 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="20" x2="18" y2="10"/>
                <line x1="12" y1="20" x2="12" y2="4"/>
                <line x1="6" y1="20" x2="6" y2="14"/>
              </svg>
              Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ø³ØªØ®Ø¯Ø§Ù… AI
            </h4>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="p-4 rounded-xl text-center" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1));">
                <p class="text-3xl font-black" style="background: linear-gradient(135deg, #8B5CF6, #EC4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent;" id="aiTotalAttempts">0</p>
                <p class="text-sm text-gray-600 font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</p>
              </div>
              <div class="p-4 rounded-xl text-center" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));">
                <p class="text-3xl font-black text-green-600" id="aiUniqueUsers">0</p>
                <p class="text-sm text-gray-600 font-bold">Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙØ±ÙŠØ¯ÙˆÙ†</p>
              </div>
              <div class="p-4 rounded-xl text-center" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1));">
                <p class="text-3xl font-black text-amber-600" id="aiTodayAttempts">0</p>
                <p class="text-sm text-gray-600 font-bold">Ø§Ù„ÙŠÙˆÙ…</p>
              </div>
            </div>
            
            <!-- Most Popular Products in AI -->
            <div class="mb-6">
              <h5 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#F59E0B" stroke-width="2">
                  <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                </svg>
                Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ø§Ù‹ ÙÙŠ AI
              </h5>
              <div id="aiPopularProducts" class="space-y-2">
                <p class="text-gray-500 text-sm text-center py-4">Ø§Ø¶ØºØ· "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</p>
              </div>
            </div>
            
            <!-- Popular Colors -->
            <div class="mb-6">
              <h5 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="13.5" cy="6.5" r="2.5"/>
                  <circle cx="17.5" cy="10.5" r="2.5"/>
                  <circle cx="8.5" cy="7.5" r="2.5"/>
                  <circle cx="6.5" cy="12.5" r="2.5"/>
                  <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 011.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.555C21.965 6.012 17.461 2 12 2z"/>
                </svg>
                Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø®ØªÙŠØ§Ø±Ø§Ù‹
              </h5>
              <div id="aiPopularColors" class="flex flex-wrap gap-3">
                <p class="text-gray-500 text-sm">Ø§Ø¶ØºØ· "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù„ÙˆØ§Ù†</p>
              </div>
            </div>
            
            <!-- Recent AI Attempts -->
            <div>
              <h5 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
                Ø¢Ø®Ø± Ù…Ø­Ø§ÙˆÙ„Ø§Øª AI
              </h5>
              <div id="aiRecentAttempts" class="bg-gray-50 rounded-xl p-4 max-h-64 overflow-y-auto">
                <p class="text-gray-500 text-sm text-center py-4">Ø§Ø¶ØºØ· "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</p>
              </div>
            </div>
            
            <!-- Refresh and Export -->
            <div class="mt-4 flex gap-3">
              <button onclick="refreshAiStats()" class="flex-1 text-white px-4 py-3 rounded-xl transition font-bold flex items-center justify-center gap-2" style="background: linear-gradient(135deg, #8B5CF6, #EC4899);">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="23 4 23 10 17 10"/>
                  <path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/>
                </svg>
                ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
              </button>
              <button onclick="exportAiStats()" class="bg-green-600 text-white px-4 py-3 rounded-xl hover:bg-green-700 transition font-bold flex items-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                ØªØµØ¯ÙŠØ±
              </button>
              <button onclick="clearAiStats()" class="bg-red-600 text-white px-4 py-3 rounded-xl hover:bg-red-700 transition font-bold flex items-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
                Ù…Ø³Ø­
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Product Modal -->
  <div id="addProductModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="card rounded-3xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <h3 class="text-2xl font-bold text-gray-900 mb-6">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
      <form id="addProductForm" class="space-y-4">
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
          <input type="text" id="productName" required class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900">
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
          <div class="flex gap-2">
            <select id="productCollection" required class="flex-1 px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900">
              <option value="Ø±Ù…Ø³ÙŠØ³">Ø±Ù…Ø³ÙŠØ³</option>
              <option value="Ø±ÙˆÙŠØ§Ù„">Ø±ÙˆÙŠØ§Ù„</option>
              <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
            </select>
            <button type="button" onclick="openCreateCategory('add')" class="gold-gradient text-black font-bold px-6 py-3 rounded-xl hover:shadow-lg transition whitespace-nowrap flex items-center gap-2">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Ø¥Ù†Ø´Ø§Ø¡ ÙØ¦Ø©
            </button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„ÙˆØµÙ</label>
          <textarea id="productDescription" rows="3" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input type="number" id="productOldPrice" placeholder="Ù„Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„ØªØ®ÙÙŠØ¶Ø§Øª" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900">
            <p class="text-xs text-gray-500 mt-1">Ø³ÙŠØ¸Ù‡Ø± Ù…Ø´Ø·ÙˆØ¨ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±</p>
          </div>
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¯ÙŠÙ†Ø§Ø±) *</label>
            <input type="number" id="productPrice" required class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900">
          </div>
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬ *</label>
          <input type="file" id="productImages" multiple accept="image/*" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900">
          <p class="text-xs text-gray-500 mt-1">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ± Ù…ØªØ¹Ø¯Ø¯Ø© (Ctrl + Click) - Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¬Ù…Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</p>
          <div id="imagePreview" class="grid grid-cols-4 gap-2 mt-3"></div>
        </div>
        <div class="flex gap-4 pt-4">
          <button type="submit" class="flex-1 gold-gradient text-black font-bold py-3 rounded-xl">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬</button>
          <button type="button" onclick="closeAddProduct()" class="flex-1 bg-red-50 text-red-600 font-bold py-3 rounded-xl hover:bg-red-100 transition">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Category Modal -->
  <div id="createCategoryModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="card rounded-3xl p-8 max-w-md w-full">
      <h3 class="text-2xl font-bold text-gray-900 mb-6">Ø¥Ù†Ø´Ø§Ø¡ ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
      <form id="createCategoryForm" class="space-y-4">
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©</label>
          <input type="text" id="newCategoryName" required placeholder="Ù…Ø«Ø§Ù„: ÙƒÙ„Ø§Ø³ÙŠÙƒØŒ Ù…ÙˆØ¯Ø±Ù†ØŒ Ù„ÙˆÙƒØ³..." class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900">
        </div>
        <div class="flex gap-4 pt-4">
          <button type="submit" class="flex-1 gold-gradient text-black font-bold py-3 rounded-xl">Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø©</button>
          <button type="button" onclick="closeCreateCategory()" class="flex-1 bg-red-50 text-red-600 font-bold py-3 rounded-xl hover:bg-red-100 transition">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Product Modal -->
  <div id="editProductModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 z-50">
    <div class="card rounded-3xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <h3 class="text-2xl font-bold text-gray-900 mb-6">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</h3>
      <form id="editProductForm" class="space-y-4">
        <input type="hidden" id="editProductId">
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
          <input type="text" id="editProductName" required class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900">
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
          <div class="flex gap-2">
            <select id="editProductCollection" required class="flex-1 px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900">
              <option value="Ø±Ù…Ø³ÙŠØ³">Ø±Ù…Ø³ÙŠØ³</option>
              <option value="Ø±ÙˆÙŠØ§Ù„">Ø±ÙˆÙŠØ§Ù„</option>
              <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
            </select>
            <button type="button" onclick="openCreateCategory('edit')" class="gold-gradient text-black font-bold px-6 py-3 rounded-xl hover:shadow-lg transition whitespace-nowrap flex items-center gap-2">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Ø¥Ù†Ø´Ø§Ø¡ ÙØ¦Ø©
            </button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„ÙˆØµÙ</label>
          <textarea id="editProductDescription" rows="3" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input type="number" id="editProductOldPrice" placeholder="Ù„Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„ØªØ®ÙÙŠØ¶Ø§Øª" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900">
            <p class="text-xs text-gray-500 mt-1">Ø³ÙŠØ¸Ù‡Ø± Ù…Ø´Ø·ÙˆØ¨ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±</p>
          </div>
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¯ÙŠÙ†Ø§Ø±) *</label>
            <input type="number" id="editProductPrice" required class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900">
          </div>
        </div>
        <div class="flex gap-4 pt-4">
          <button type="submit" class="flex-1 gold-gradient text-black font-bold py-3 rounded-xl">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
          <button type="button" onclick="closeEditProduct()" class="flex-1 bg-red-50 text-red-600 font-bold py-3 rounded-xl hover:bg-red-100 transition">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Mock data storage
    let products = [
      {
        id: 1,
        name: 'Ø·Ù‚Ù… Ø±Ù…Ø³ÙŠØ³ Ø§Ù„ÙØ§Ø®Ø±',
        collection: 'Ø±Ù…Ø³ÙŠØ³',
        description: 'Ø·Ù‚Ù… Ù…ÙØ±ÙˆØ´Ø§Øª ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ ÙØ§Ø®Ø± Ø¨ØªØµÙ…ÙŠÙ… Ø±Ù…Ø³ÙŠØ³ Ø§Ù„Ø£ØµÙŠÙ„',
        price: 2499,
        oldPrice: null,
        images: []
      },
      {
        id: 2,
        name: 'Ø·Ù‚Ù… Ø±ÙˆÙŠØ§Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠ',
        collection: 'Ø±ÙˆÙŠØ§Ù„',
        description: 'Ø·Ù‚Ù… Ù…ÙØ±ÙˆØ´Ø§Øª Ù…Ù„ÙƒÙŠ Ø¨ØªØµÙ…ÙŠÙ… Ø¹ØµØ±ÙŠ Ø±Ø§Ù‚ÙŠ',
        price: 3299,
        oldPrice: 3999,
        images: []
      }
    ];

    let orders = [];
    let deletedProducts = [];
    let currentUser = null;
    let nextProductId = 3;
    let nextOrderId = 1;
    let db = null; // IndexedDB instance
    let isPersistent = false;
    let currentFilter = 'all'; // Product filter state
    let isOnlineMode = false; // Are we using server API?

    // Check if we're running on a server with API support
    async function checkServerMode() {
      try {
        const response = await fetch('/api/products', { method: 'GET' });
        if (response.ok) {
          isOnlineMode = true;
          console.log('âœ… Server API detected - using online storage');
          return true;
        }
      } catch (e) {
        console.log('ğŸ“‚ No server API - using local storage');
      }
      isOnlineMode = false;
      return false;
    }

    // Request persistent storage (600MB+)
    async function requestPersistentStorage() {
      try {
        if (navigator.storage && navigator.storage.persist) {
          isPersistent = await navigator.storage.persist();
          console.log('Persistent storage granted:', isPersistent);
          
          // Estimate storage quota
          if (navigator.storage && navigator.storage.estimate) {
            const estimate = await navigator.storage.estimate();
            const percentUsed = (estimate.usage / estimate.quota * 100).toFixed(2);
            console.log(`Storage: ${(estimate.usage / 1024 / 1024).toFixed(2)} MB / ${(estimate.quota / 1024 / 1024).toFixed(2)} MB (${percentUsed}%)`);
          }
        }
      } catch (error) {
        console.error('Could not request persistent storage:', error);
      }
    }

    // Initialize IndexedDB for larger storage (600MB+)
    function initIndexedDB() {
      return new Promise(async (resolve, reject) => {
        // Request persistent storage first
        await requestPersistentStorage();
        
        const request = indexedDB.open('AlZainDB', 1);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
          const database = event.target.result;
          
          // Create object stores if they don't exist
          if (!database.objectStoreNames.contains('products')) {
            database.createObjectStore('products', { keyPath: 'id' });
          }
          if (!database.objectStoreNames.contains('orders')) {
            database.createObjectStore('orders', { keyPath: 'id' });
          }
          if (!database.objectStoreNames.contains('deletedProducts')) {
            database.createObjectStore('deletedProducts', { keyPath: 'id' });
          }
          if (!database.objectStoreNames.contains('categories')) {
            database.createObjectStore('categories');
          }
        };
      });
    }

    // Load from Server API (primary) or IndexedDB/localStorage (fallback)
    async function loadData() {
      try {
        // Check if server API is available
        await checkServerMode();
        
        if (isOnlineMode) {
          // Load from server API
          console.log('ğŸ“¡ Loading data from server...');
          const response = await fetch('/api/products');
          const data = await response.json();
          
          if (data.success && data.products) {
            products = data.products;
            console.log(`âœ… Loaded ${products.length} products from server`);
          }
          
          // Load orders and deleted from localStorage (server doesn't store these yet)
          const savedOrders = localStorage.getItem('alzain_orders');
          const savedDeleted = localStorage.getItem('alzain_deleted_products');
          if (savedOrders) orders = JSON.parse(savedOrders);
          if (savedDeleted) deletedProducts = JSON.parse(savedDeleted);
          
        } else {
          // Fallback to IndexedDB/localStorage
          if (!db) await initIndexedDB();
          
          const transaction = db.transaction(['products', 'orders', 'deletedProducts'], 'readonly');
          
          const productsStore = transaction.objectStore('products');
          const ordersStore = transaction.objectStore('orders');
          const deletedStore = transaction.objectStore('deletedProducts');
          
          products = await getAll(productsStore);
          orders = await getAll(ordersStore);
          deletedProducts = await getAll(deletedStore);
          
          // Fallback to localStorage if IndexedDB is empty
          if (products.length === 0) {
            const savedProducts = localStorage.getItem('alzain_products');
            if (savedProducts) {
              products = JSON.parse(savedProducts);
              await saveData();
            }
          }
          
          if (orders.length === 0) {
            const savedOrders = localStorage.getItem('alzain_orders');
            if (savedOrders) orders = JSON.parse(savedOrders);
          }
          
          if (deletedProducts.length === 0) {
            const savedDeleted = localStorage.getItem('alzain_deleted_products');
            if (savedDeleted) deletedProducts = JSON.parse(savedDeleted);
          }
        }
        
      } catch (error) {
        console.error('Load error, falling back to localStorage:', error);
        const savedProducts = localStorage.getItem('alzain_products');
        const savedOrders = localStorage.getItem('alzain_orders');
        const savedDeletedProducts = localStorage.getItem('alzain_deleted_products');
        
        if (savedProducts) products = JSON.parse(savedProducts);
        if (savedOrders) orders = JSON.parse(savedOrders);
        if (savedDeletedProducts) deletedProducts = JSON.parse(savedDeletedProducts);
      }
      
      nextProductId = Math.max(...products.map(p => p.id), 0) + 1;
      nextOrderId = Math.max(...orders.map(o => o.id), 0) + 1;
    }

    // Helper function to get all items from IndexedDB store
    function getAll(objectStore) {
      return new Promise((resolve, reject) => {
        const request = objectStore.getAll();
        request.onsuccess = () => resolve(request.result || []);
        request.onerror = () => reject(request.error);
      });
    }

    // Save to Server API (primary) or IndexedDB/localStorage (fallback)
    async function saveData() {
      try {
        if (isOnlineMode) {
          // Save to server API
          console.log('ğŸ“¡ Saving data to server...');
          const response = await fetch('/api/products', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ products })
          });
          
          const data = await response.json();
          if (data.success) {
            console.log('âœ… Products saved to server');
          } else {
            throw new Error(data.error || 'Save failed');
          }
          
          // Save orders and deleted to localStorage
          localStorage.setItem('alzain_orders', JSON.stringify(orders));
          localStorage.setItem('alzain_deleted_products', JSON.stringify(deletedProducts));
          
        } else {
          // Save to IndexedDB
          if (db) {
            const transaction = db.transaction(['products', 'orders', 'deletedProducts'], 'readwrite');
            
            const productsStore = transaction.objectStore('products');
            const ordersStore = transaction.objectStore('orders');
            const deletedStore = transaction.objectStore('deletedProducts');
            
            await clearAndPut(productsStore, products);
            await clearAndPut(ordersStore, orders);
            await clearAndPut(deletedStore, deletedProducts);
          }
          
          // Also save to localStorage as backup
          try {
            localStorage.setItem('alzain_products', JSON.stringify(products));
            localStorage.setItem('alzain_orders', JSON.stringify(orders));
            localStorage.setItem('alzain_deleted_products', JSON.stringify(deletedProducts));
          } catch (e) {
            console.log('localStorage full, using IndexedDB only');
          }
        }
        
        return true;
      } catch (e) {
        console.error('Save error:', e);
        // Fallback to localStorage
        try {
          localStorage.setItem('alzain_products', JSON.stringify(products));
          localStorage.setItem('alzain_orders', JSON.stringify(orders));
          localStorage.setItem('alzain_deleted_products', JSON.stringify(deletedProducts));
        } catch (e2) {
          console.error('All save methods failed');
        }
        return false;
      }
    }

    // Helper function to clear and put items in IndexedDB
    async function clearAndPut(objectStore, items) {
      return new Promise((resolve, reject) => {
        const clearRequest = objectStore.clear();
        clearRequest.onsuccess = () => {
          let completed = 0;
          if (items.length === 0) {
            resolve();
            return;
          }
          
          items.forEach(item => {
            const putRequest = objectStore.put(item);
            putRequest.onsuccess = () => {
              completed++;
              if (completed === items.length) resolve();
            };
            putRequest.onerror = () => reject(putRequest.error);
          });
        };
        clearRequest.onerror = () => reject(clearRequest.error);
      });
    }

    // Compress image function
    function compressImage(file, maxWidth = 800, quality = 0.7) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = new Image();
          img.onload = function() {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            // Calculate new dimensions
            if (width > height) {
              if (width > maxWidth) {
                height = Math.round((height * maxWidth) / width);
                width = maxWidth;
              }
            } else {
              if (height > maxWidth) {
                width = Math.round((width * maxWidth) / height);
                height = maxWidth;
              }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // Convert to compressed base64
            const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
            resolve(compressedDataUrl);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // Mobile sidebar functions
    function toggleMobileSidebar() {
      const sidebar = document.querySelector('.w-72');
      const overlay = document.querySelector('.sidebar-overlay');
      if (sidebar) {
        sidebar.classList.toggle('mobile-open');
        sidebar.classList.add('sidebar');
      }
      if (overlay) {
        overlay.classList.toggle('active');
      }
    }
    
    function closeMobileSidebar() {
      const sidebar = document.querySelector('.w-72');
      const overlay = document.querySelector('.sidebar-overlay');
      if (sidebar) {
        sidebar.classList.remove('mobile-open');
      }
      if (overlay) {
        overlay.classList.remove('active');
      }
    }
    
    // Close sidebar when clicking a nav item on mobile
    function handleMobileNavClick() {
      if (window.innerWidth <= 768) {
        closeMobileSidebar();
      }
    }

    // Initialize on page load
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async function() {
      // Add sidebar class for mobile
      const sidebar = document.querySelector('.w-72');
      if (sidebar) {
        sidebar.classList.add('sidebar');
      }
      
      // Auto-login for development (remove password requirement)
      currentUser = 'Admin';
      document.getElementById('welcomeUser').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${currentUser}`;
      
      // Initialize IndexedDB and load data
      try {
        await initIndexedDB();
        await loadData();
      } catch (error) {
        console.error('Initialization error:', error);
        loadData(); // Fallback to localStorage
      }
      
      loadCategories(); // Load categories
      updateStats();
      loadProducts();
      
      // Load AI settings
      loadAiSettings();
      
      // Refresh analytics on page load
      setTimeout(() => {
        refreshMainSiteAnalytics();
        refreshAdminAnalytics();
        refreshAiStats(); // Also refresh AI stats
      }, 500);
      
      // Image preview on file select with star feature and compression
      document.getElementById('productImages').addEventListener('change', function(e) {
        const preview = document.getElementById('imagePreview');
        preview.innerHTML = '';
        const files = Array.from(e.target.files);
        
        // Show loading message
        if (files.length > 0) {
          preview.innerHTML = '<div class="col-span-4 text-center text-amber-600 font-bold">Ø¬Ø§Ø±ÙŠ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±...</div>';
        }
        
        // Compress all images first
        const compressPromises = files.map(file => compressImage(file));
        
        Promise.all(compressPromises).then(compressedImages => {
          preview.innerHTML = '';
          
          compressedImages.forEach((compressedSrc, index) => {
            const container = document.createElement('div');
            container.className = 'relative group';
            container.dataset.index = index;
            
            const img = document.createElement('img');
            img.src = compressedSrc;
            img.className = 'w-full h-20 object-cover rounded-lg border-2 border-amber-300';
            
            const starBtn = document.createElement('button');
            starBtn.type = 'button';
            starBtn.className = 'absolute top-1 right-1 w-6 h-6 rounded-full flex items-center justify-center transition-all';
            starBtn.style.background = index === 0 ? 'rgba(255, 193, 7, 0.95)' : 'rgba(0, 0, 0, 0.5)';
            starBtn.innerHTML = index === 0 ? 
              '<svg width="16" height="16" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="1"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>' : 
              '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';
            starBtn.title = 'ØªØ­Ø¯ÙŠØ¯ ÙƒØµÙˆØ±Ø© Ø£ÙˆÙ„Ù‰';
            
            starBtn.onclick = function() {
              // Remove star from all images
              preview.querySelectorAll('button').forEach((btn, i) => {
                btn.style.background = 'rgba(0, 0, 0, 0.5)';
                btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';
              });
              
              // Add star to clicked image
              this.style.background = 'rgba(255, 193, 7, 0.95)';
              this.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="1"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';
              
              // Store which image is starred
              preview.dataset.starredIndex = this.parentElement.dataset.index;
            };
            
            container.appendChild(img);
            container.appendChild(starBtn);
            preview.appendChild(container);
            
            // Set first image as starred by default
            if (index === 0) {
              preview.dataset.starredIndex = '0';
            }
          });
          
          // Store compressed images for later use
          preview.dataset.compressedImages = JSON.stringify(compressedImages);
        });
      });
      
      // Create Category Form Handler
      document.getElementById('createCategoryForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const categoryName = document.getElementById('newCategoryName').value.trim();
        
        if (!categoryName) {
          alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©');
          return;
        }
        
        if (categories.includes(categoryName)) {
          alert('Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„');
          return;
        }
        
        // Add the new category
        categories.push(categoryName);
        saveCategories();
        updateCategorySelects();
        
        // Select the new category in the appropriate dropdown
        const selectId = categoryFormContext === 'add' ? 'productCollection' : 'editProductCollection';
        document.getElementById(selectId).value = categoryName;
        
        // Close modal and show success message
        closeCreateCategory();
        
        // Show success notification
        const notification = document.createElement('div');
        notification.className = 'fixed top-6 left-1/2 transform -translate-x-1/2 gold-gradient text-black px-6 py-3 rounded-xl font-bold shadow-lg z-50';
        notification.textContent = `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø© "${categoryName}" Ø¨Ù†Ø¬Ø§Ø­`;
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.remove();
        }, 3000);
      });
      
      // Login form (disabled until launch)
      // document.getElementById('loginForm').addEventListener('submit', (e) => {
      //   e.preventDefault();
      //   const username = document.getElementById('username').value;
      //   const password = document.getElementById('password').value;
      //   const errorDiv = document.getElementById('error');
      //   if (username === 'admin' && password === 'admin123') {
      //     currentUser = username;
      //     document.getElementById('loginScreen').classList.add('hidden');
      //     document.getElementById('dashboardScreen').classList.remove('hidden');
      //     document.getElementById('welcomeUser').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${username}`;
      //     loadData();
      //     updateStats();
      //     loadProducts();
      //   } else {
      //     errorDiv.textContent = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
      //     errorDiv.classList.remove('hidden');
      //   }
      // });
    });

    // Logout
    function logout() {
      currentUser = null;
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('dashboardScreen').classList.add('hidden');
      document.getElementById('loginForm').reset();
      document.getElementById('error').classList.add('hidden');
    }

    // Update stats
    async function updateStats() {
      document.getElementById('totalProducts').textContent = products.length;
      document.getElementById('newOrders').textContent = orders.filter(o => o.status === 'new').length;
      document.getElementById('processingOrders').textContent = orders.filter(o => o.status === 'processing').length;
      document.getElementById('completedOrders').textContent = orders.filter(o => o.status === 'completed').length;
      
      // Calculate storage usage
      try {
        // Get accurate storage estimate from browser
        if (navigator.storage && navigator.storage.estimate) {
          const estimate = await navigator.storage.estimate();
          const usageInMB = (estimate.usage / 1024 / 1024).toFixed(2);
          const quotaInMB = (estimate.quota / 1024 / 1024).toFixed(0);
          const percentUsed = (estimate.usage / estimate.quota * 100).toFixed(1);
          
          document.getElementById('storageUsage').textContent = `${usageInMB} MB`;
          
          const percentEl = document.getElementById('storagePercent');
          
          if (db && isPersistent) {
            percentEl.textContent = `${percentUsed}% Ù…Ù† ${quotaInMB} MB (Ø¯Ø§Ø¦Ù…)`;
            percentEl.className = 'text-xs text-green-600 mt-1 font-bold';
            document.getElementById('storageUsage').className = 'text-2xl font-black text-green-600';
          } else if (db) {
            percentEl.textContent = `${percentUsed}% Ù…Ù† ${quotaInMB} MB`;
            
            // Color code based on usage
            if (percentUsed > 80) {
              percentEl.className = 'text-xs text-red-600 mt-1 font-bold';
              document.getElementById('storageUsage').className = 'text-2xl font-black text-red-600';
            } else if (percentUsed > 60) {
              percentEl.className = 'text-xs text-amber-600 mt-1 font-bold';
              document.getElementById('storageUsage').className = 'text-2xl font-black text-amber-600';
            } else {
              percentEl.className = 'text-xs text-blue-600 mt-1 font-bold';
              document.getElementById('storageUsage').className = 'text-2xl font-black text-blue-600';
            }
          }
        } else {
          // Fallback to localStorage calculation
          let totalSize = 0;
          for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
              totalSize += localStorage[key].length + key.length;
            }
          }
          
          const sizeInKB = totalSize / 1024;
          const sizeInMB = sizeInKB / 1024;
          
          let sizeText = sizeInKB < 1024 
            ? `${sizeInKB.toFixed(1)} KB`
            : `${sizeInMB.toFixed(2)} MB`;
          
          document.getElementById('storageUsage').textContent = sizeText;
          
          const percentEl = document.getElementById('storagePercent');
          const maxSize = 10 * 1024; // 10MB typical limit
          const percentage = ((totalSize / 1024) / maxSize * 100).toFixed(1);
          percentEl.textContent = `${percentage}% (localStorage)`;
          
          if (percentage > 80) {
            percentEl.className = 'text-xs text-red-600 mt-1 font-bold';
            document.getElementById('storageUsage').className = 'text-2xl font-black text-red-600';
          } else {
            percentEl.className = 'text-xs text-gray-500 mt-1';
            document.getElementById('storageUsage').className = 'text-2xl font-black text-gray-900';
          }
        }
      } catch (e) {
        console.error('Error calculating storage:', e);
      }
    }

    // Load products
    // Load products with filter
    function loadProducts() {
      const productsList = document.getElementById('productsList');
      
      // Filter products based on current filter
      let filteredProducts = products;
      if (currentFilter === 'active') {
        filteredProducts = products.filter(p => p.isActive !== false);
      } else if (currentFilter === 'inactive') {
        filteredProducts = products.filter(p => p.isActive === false);
      }
      
      // Update counts
      document.getElementById('countAll').textContent = products.length;
      document.getElementById('countActive').textContent = products.filter(p => p.isActive !== false).length;
      document.getElementById('countInactive').textContent = products.filter(p => p.isActive === false).length;
      
      if (filteredProducts.length === 0) {
        productsList.innerHTML = `
          <div class="col-span-3 card rounded-2xl p-12 text-center">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mx-auto mb-4 text-gray-400">
              <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/>
              <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
              <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
              <line x1="12" y1="22.08" x2="12" y2="12"/>
            </svg>
            <p class="text-gray-600 text-lg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ${currentFilter === 'active' ? 'Ù†Ø´Ø·Ø©' : currentFilter === 'inactive' ? 'ØºÙŠØ± Ù†Ø´Ø·Ø©' : ''}</p>
          </div>
        `;
        return;
      }
      
      productsList.innerHTML = filteredProducts.map(product => {
        const isActive = product.isActive !== false; // Default to active
        return `
        <div class="card rounded-2xl p-6 ${!isActive ? 'opacity-60' : ''}">
          ${!isActive ? '<div class="bg-gray-500 text-white text-xs font-bold px-3 py-1 rounded-full inline-flex items-center gap-1 mb-2"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg> ØºÙŠØ± Ù†Ø´Ø·</div>' : '<div class="bg-green-500 text-white text-xs font-bold px-3 py-1 rounded-full inline-flex items-center gap-1 mb-2"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg> Ù†Ø´Ø·</div>'}
          <div class="aspect-video bg-gradient-to-br from-amber-500/10 to-amber-600/5 rounded-xl mb-4 flex items-center justify-center overflow-hidden">
            ${product.images && product.images.length > 0 ? `<img src="${product.images[0]}" class="w-full h-full object-cover ${!isActive ? 'grayscale' : ''}">` : '<div class="text-6xl">ğŸ›‹ï¸</div>'}
          </div>
          <h3 class="text-xl font-bold text-gray-900 mb-2">${product.name}</h3>
          <p class="text-gray-600 text-sm mb-2">${product.collection}</p>
          <p class="text-gray-600 text-sm mb-3">${product.description || ''}</p>
          <div class="mb-4">
            ${product.oldPrice ? `<p class="text-lg font-bold text-red-500 line-through mb-1">${product.oldPrice.toLocaleString()} Ø¯ÙŠÙ†Ø§Ø±</p>` : ''}
            <p class="text-2xl font-black gold-gradient bg-clip-text text-transparent">${product.price.toLocaleString()} Ø¯ÙŠÙ†Ø§Ø±</p>
          </div>
          <div class="flex gap-2 mb-2">
            <button onclick="toggleProductStatus(${product.id})" class="flex-1 ${isActive ? 'bg-orange-50 text-orange-600 hover:bg-orange-100' : 'bg-green-50 text-green-600 hover:bg-green-100'} px-4 py-2 rounded-xl text-sm transition font-bold inline-flex items-center justify-center gap-2">
              ${isActive ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="6" y="4" width="12" height="16" rx="2"/></svg> Ø¥ÙŠÙ‚Ø§Ù' : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="5 3 19 12 5 21 5 3"/></svg> ØªÙØ¹ÙŠÙ„'}
            </button>
          </div>
          <div class="flex gap-2">
            <button onclick="editProduct(${product.id})" class="flex-1 bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-sm hover:bg-blue-100 transition inline-flex items-center justify-center gap-2">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
              ØªØ¹Ø¯ÙŠÙ„
            </button>
            <button onclick="deleteProduct(${product.id})" class="flex-1 bg-red-50 text-red-600 px-4 py-2 rounded-xl text-sm hover:bg-red-100 transition inline-flex items-center justify-center gap-2">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
              Ø­Ø°Ù
            </button>
          </div>
        </div>
      `;
      }).join('');
    }
    
    // Filter products
    function filterProducts(filter) {
      currentFilter = filter;
      
      // Update button styles
      document.getElementById('filterAll').className = 'px-4 py-2 rounded-lg font-bold ' + 
        (filter === 'all' ? 'bg-gray-900 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200 transition');
      document.getElementById('filterActive').className = 'px-4 py-2 rounded-lg font-bold ' + 
        (filter === 'active' ? 'bg-gray-900 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200 transition');
      document.getElementById('filterInactive').className = 'px-4 py-2 rounded-lg font-bold ' + 
        (filter === 'inactive' ? 'bg-gray-900 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200 transition');
      
      loadProducts();
    }
    
    // Toggle product active status
    function toggleProductStatus(id) {
      const product = products.find(p => p.id === id);
      if (product) {
        product.isActive = product.isActive === false ? true : false;
        saveData();
        loadProducts();
        const icon = product.isActive 
          ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>'
          : '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="6" y="4" width="12" height="16" rx="2"/></svg>';
        showNotification(icon + (product.isActive ? ' ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬' : ' ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ù†ØªØ¬'));
      }
    }

    // Load orders
    function loadOrders() {
      const ordersList = document.getElementById('ordersList');
      
      if (orders.length === 0) {
        ordersList.innerHTML = `
          <div class="card rounded-2xl p-12 text-center">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mx-auto mb-4 text-gray-400">
              <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/>
              <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
              <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
              <line x1="12" y1="22.08" x2="12" y2="12"/>
            </svg>
            <p class="text-gray-600 text-lg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
          </div>
        `;
        return;
      }

      const statusColors = {
        'new': 'bg-amber-50 text-amber-700 border border-amber-200',
        'processing': 'bg-blue-50 text-blue-700 border border-blue-200',
        'completed': 'bg-green-50 text-green-700 border border-green-200',
        'cancelled': 'bg-red-50 text-red-700 border border-red-200'
      };
      
      const statusText = {
        'new': 'Ø¬Ø¯ÙŠØ¯',
        'processing': 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°',
        'completed': 'Ù…ÙƒØªÙ…Ù„',
        'cancelled': 'Ù…Ù„ØºÙŠ'
      };

      ordersList.innerHTML = orders.map(order => `
        <div class="card rounded-2xl p-6">
          <div class="flex justify-between items-start mb-4">
            <div>
              <h3 class="text-xl font-bold text-gray-900">${order.customerName}</h3>
              <p class="text-gray-600 text-sm">${order.customerEmail || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø±ÙŠØ¯'}</p>
              <p class="text-gray-600 text-sm">${order.customerPhone}</p>
            </div>
            <span class="px-4 py-2 rounded-xl text-sm font-bold ${statusColors[order.status]}">${statusText[order.status]}</span>
          </div>
          <div class="border-t border-white/10 pt-4">
            <p class="text-gray-900 mb-2"><strong>Ø§Ù„Ù…Ù†ØªØ¬:</strong> ${order.productName}</p>
            <p class="text-gray-900 mb-2"><strong>Ø§Ù„ÙƒÙ…ÙŠØ©:</strong> ${order.quantity}</p>
            <p class="text-2xl font-black gold-gradient bg-clip-text text-transparent mb-4">${order.totalPrice.toLocaleString()} Ø¯ÙŠÙ†Ø§Ø±</p>
            ${order.notes ? `<p class="text-gray-600 text-sm mb-4"><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${order.notes}</p>` : ''}
            <p class="text-gray-500 text-xs mb-4">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨: ${new Date(order.createdAt).toLocaleDateString('ar-SA')}</p>
            <div class="flex gap-2">
              <select onchange="updateOrderStatus(${order.id}, this.value)" class="flex-1 px-4 py-2 bg-white border border-gray-300 rounded-xl text-gray-900 text-sm">
                <option value="new" ${order.status === 'new' ? 'selected' : ''}>Ø¬Ø¯ÙŠØ¯</option>
                <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Ù…ÙƒØªÙ…Ù„</option>
                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Ù…Ù„ØºÙŠ</option>
              </select>
              <button onclick="deleteOrder(${order.id})" class="bg-red-50 text-red-600 px-4 py-2 rounded-xl text-sm hover:bg-red-100 transition">
                Ø­Ø°Ù
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Show/hide tabs
    function showTab(tab) {
      // Hide all tabs
      document.getElementById('productsContent').classList.add('hidden');
      document.getElementById('ordersContent').classList.add('hidden');
      document.getElementById('recycleContent').classList.add('hidden');
      document.getElementById('settingsContent').classList.add('hidden');
      document.getElementById('aiContent').classList.add('hidden');
      
      // Reset all tab styles
      const tabBaseClass = 'px-6 py-3 rounded-xl font-bold bg-gray-100 text-gray-700 hover:bg-gray-200 transition flex items-center gap-2';
      const tabActiveClass = 'px-6 py-3 rounded-xl font-bold gold-gradient text-black flex items-center gap-2';
      const aiTabBaseClass = 'px-6 py-3 rounded-xl font-bold bg-gray-100 text-gray-700 hover:bg-gray-200 transition flex items-center gap-2';
      const aiTabActiveClass = 'px-6 py-3 rounded-xl font-bold flex items-center gap-2';
      
      document.getElementById('productsTab').className = tabBaseClass;
      document.getElementById('ordersTab').className = tabBaseClass;
      document.getElementById('recycleTab').className = tabBaseClass;
      document.getElementById('settingsTab').className = tabBaseClass;
      document.getElementById('aiTab').className = aiTabBaseClass;
      document.getElementById('aiTab').style.background = 'linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1))';
      
      // Show selected tab
      if (tab === 'products') {
        document.getElementById('productsContent').classList.remove('hidden');
        document.getElementById('productsTab').className = tabActiveClass;
      } else if (tab === 'orders') {
        document.getElementById('ordersContent').classList.remove('hidden');
        document.getElementById('ordersTab').className = tabActiveClass;
        loadOrders();
      } else if (tab === 'recycle') {
        document.getElementById('recycleContent').classList.remove('hidden');
        document.getElementById('recycleTab').className = tabActiveClass;
        loadRecycleBin();
      } else if (tab === 'settings') {
        document.getElementById('settingsContent').classList.remove('hidden');
        document.getElementById('settingsTab').className = tabActiveClass;
        loadMetaPixelSettings();
      } else if (tab === 'ai') {
        document.getElementById('aiContent').classList.remove('hidden');
        document.getElementById('aiTab').className = aiTabActiveClass;
        document.getElementById('aiTab').style.background = 'linear-gradient(135deg, #8B5CF6, #EC4899)';
        document.getElementById('aiTab').querySelector('span').style.color = 'white';
        document.getElementById('aiTab').querySelector('span').style.webkitTextFillColor = 'white';
        loadAiSettings();
        refreshAiStats();
      }
    }

    // Meta Pixel Functions
    function loadMetaPixelSettings() {
      const pixelId = localStorage.getItem('alzain_meta_pixel_id') || '';
      document.getElementById('metaPixelId').value = pixelId;
    }
    
    function togglePixelInputMethod(method) {
      const idInput = document.getElementById('pixelIdInput');
      const codeInput = document.getElementById('pixelCodeInput');
      const methodIdBtn = document.getElementById('pixelMethodId');
      const methodCodeBtn = document.getElementById('pixelMethodCode');
      
      if (method === 'id') {
        idInput.classList.remove('hidden');
        codeInput.classList.add('hidden');
        methodIdBtn.className = 'px-4 py-2 rounded-lg font-bold bg-gray-900 text-white text-sm';
        methodCodeBtn.className = 'px-4 py-2 rounded-lg font-bold bg-gray-100 text-gray-700 hover:bg-gray-200 transition text-sm';
      } else {
        idInput.classList.add('hidden');
        codeInput.classList.remove('hidden');
        methodIdBtn.className = 'px-4 py-2 rounded-lg font-bold bg-gray-100 text-gray-700 hover:bg-gray-200 transition text-sm';
        methodCodeBtn.className = 'px-4 py-2 rounded-lg font-bold bg-gray-900 text-white text-sm';
      }
      
      // Hide extracted ID display when switching
      document.getElementById('extractedIdDisplay').classList.add('hidden');
    }
    
    function extractPixelId() {
      const code = document.getElementById('metaPixelCode').value;
      
      if (!code.trim()) {
        showPixelStatus('error', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù„ØµÙ‚ ÙƒÙˆØ¯ Ø§Ù„Ø¨ÙƒØ³Ù„ Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }
      
      // Try to extract pixel ID from the code using multiple patterns
      let pixelId = null;
      
      // Pattern 1: fbq('init', 'PIXEL_ID')
      const initMatch = code.match(/fbq\s*\(\s*['"]init['"]\s*,\s*['"](\d{15,16})['"]/);
      if (initMatch) {
        pixelId = initMatch[1];
      }
      
      // Pattern 2: id=PIXEL_ID in URL
      if (!pixelId) {
        const urlMatch = code.match(/[?&]id=(\d{15,16})/);
        if (urlMatch) {
          pixelId = urlMatch[1];
        }
      }
      
      // Pattern 3: Just find any 15-16 digit number
      if (!pixelId) {
        const numMatch = code.match(/['"](\d{15,16})['"]/);
        if (numMatch) {
          pixelId = numMatch[1];
        }
      }
      
      if (pixelId) {
        // Set the extracted ID to the input field
        document.getElementById('metaPixelId').value = pixelId;
        
        // Show the extracted ID display
        const extractedDisplay = document.getElementById('extractedIdDisplay');
        extractedDisplay.classList.remove('hidden');
        document.getElementById('extractedIdValue').textContent = pixelId;
        
        showPixelStatus('success', 'ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¨ÙƒØ³Ù„ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ø¶ØºØ· "Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª" Ù„Ù„ØªØ·Ø¨ÙŠÙ‚');
      } else {
        showPixelStatus('error', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¨ÙƒØ³Ù„ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯. ØªØ£ÙƒØ¯ Ù…Ù† Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØµØ­ÙŠØ­');
      }
    }
    
    function saveMetaPixel() {
      const pixelId = document.getElementById('metaPixelId').value.trim();
      
      if (pixelId && !/^\d{15,16}$/.test(pixelId)) {
        showPixelStatus('error', 'Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¨ÙƒØ³Ù„ ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù…Ø§Ù‹ Ù…ÙƒÙˆÙ†Ø§Ù‹ Ù…Ù† 15-16 Ø±Ù‚Ù…');
        return;
      }
      
      localStorage.setItem('alzain_meta_pixel_id', pixelId);
      
      if (pixelId) {
        showPixelStatus('success', 'ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¨ÙƒØ³Ù„ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹');
      } else {
        showPixelStatus('info', 'ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¨ÙƒØ³Ù„. Ù„Ù† ÙŠØªÙ… ØªØªØ¨Ø¹ Ø§Ù„Ø²ÙˆØ§Ø±');
      }
      
      showNotification('<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg> ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙƒØ³Ù„');
      
      // Track admin action
      trackAdminSettingsChange('meta_pixel', pixelId || 'removed');
    }
    
    function testMetaPixel() {
      const pixelId = document.getElementById('metaPixelId').value.trim();
      
      if (!pixelId) {
        showPixelStatus('error', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¨ÙƒØ³Ù„ Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }
      
      if (!/^\d{15,16}$/.test(pixelId)) {
        showPixelStatus('error', 'Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¨ÙƒØ³Ù„ ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù…Ø§Ù‹ Ù…ÙƒÙˆÙ†Ø§Ù‹ Ù…Ù† 15-16 Ø±Ù‚Ù…');
        return;
      }
      
      // Open Facebook Pixel Helper page
      window.open('https://www.facebook.com/events_manager2/overview?pixel_id=' + pixelId, '_blank');
      showPixelStatus('info', 'ØªÙ… ÙØªØ­ ØµÙØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ø£Ø­Ø¯Ø§Ø«. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨ÙƒØ³Ù„ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
    }
    
    // Check Pixel Health - verify settings are saved and connection works
    async function checkPixelHealth() {
      const healthStatus = document.getElementById('pixelHealthStatus');
      const pixelId = document.getElementById('metaPixelId').value.trim();
      const savedPixelId = localStorage.getItem('alzain_meta_pixel_id');
      
      let checks = [];
      let allPassed = true;
      
      // Show loading state
      healthStatus.classList.remove('hidden');
      healthStatus.className = 'p-4 rounded-xl border border-blue-200 bg-blue-50';
      healthStatus.innerHTML = `
        <div class="flex items-center gap-2 text-blue-800">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="animate-spin">
            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0118.8-4.3M22 12.5a10 10 0 01-18.8 4.2"/>
          </svg>
          Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„...
        </div>
      `;
      
      await new Promise(r => setTimeout(r, 500));
      
      // Check 1: Pixel ID format
      if (pixelId && /^\d{15,16}$/.test(pixelId)) {
        checks.push({ status: 'success', text: 'ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ØµØ­ÙŠØ­' });
      } else if (!pixelId) {
        checks.push({ status: 'error', text: 'Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¨ÙƒØ³Ù„' });
        allPassed = false;
      } else {
        checks.push({ status: 'error', text: 'ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ØºÙŠØ± ØµØ­ÙŠØ­' });
        allPassed = false;
      }
      
      // Check 2: Settings saved in localStorage
      if (savedPixelId && savedPixelId === pixelId) {
        checks.push({ status: 'success', text: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ' });
      } else if (savedPixelId && savedPixelId !== pixelId) {
        checks.push({ status: 'warning', text: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø®ØªÙ„ÙØ© - Ø§Ø¶ØºØ· Ø­ÙØ¸' });
        allPassed = false;
      } else {
        checks.push({ status: 'error', text: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø© - Ø§Ø¶ØºØ· Ø­ÙØ¸ Ø£ÙˆÙ„Ø§Ù‹' });
        allPassed = false;
      }
      
      // Check 3: Test Facebook connection
      if (pixelId) {
        try {
          const testUrl = 'https://www.facebook.com/tr?id=' + pixelId + '&ev=PageView&noscript=1';
          const img = new Image();
          let loaded = false;
          
          await new Promise((resolve) => {
            img.onload = () => { loaded = true; resolve(); };
            img.onerror = () => { loaded = true; resolve(); }; // Even errors mean connection works
            img.src = testUrl;
            setTimeout(resolve, 3000); // Timeout after 3 seconds
          });
          
          checks.push({ status: 'success', text: 'Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®ÙˆØ§Ø¯Ù… ÙÙŠØ³Ø¨ÙˆÙƒ ÙŠØ¹Ù…Ù„' });
        } catch (e) {
          checks.push({ status: 'warning', text: 'ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ - Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù…Ø­Ø¬ÙˆØ¨Ø§Ù‹' });
        }
      }
      
      // Check 4: IndexedDB sync (if using it)
      try {
        const testRead = localStorage.getItem('alzain_meta_pixel_id');
        if (testRead !== null || testRead === '') {
          checks.push({ status: 'success', text: 'Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­' });
        }
      } catch (e) {
        checks.push({ status: 'error', text: 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ' });
        allPassed = false;
      }
      
      // Display results
      const statusClass = allPassed ? 'border-green-200 bg-green-50' : 'border-yellow-200 bg-yellow-50';
      const headerIcon = allPassed 
        ? '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>'
        : '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ca8a04" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>';
      
      const headerText = allPassed ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ­ÙˆØµØ§Øª Ù†Ø§Ø¬Ø­Ø©!' : 'ÙŠÙˆØ¬Ø¯ Ø¨Ø¹Ø¶ Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª';
      const headerColor = allPassed ? 'text-green-800' : 'text-yellow-800';
      
      let checksHtml = checks.map(check => {
        const icon = check.status === 'success' 
          ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>'
          : check.status === 'warning'
          ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ca8a04" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>'
          : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
        const textColor = check.status === 'success' ? 'text-green-700' : check.status === 'warning' ? 'text-yellow-700' : 'text-red-700';
        return `<li class="flex items-center gap-2 ${textColor}">${icon} ${check.text}</li>`;
      }).join('');
      
      healthStatus.className = 'p-4 rounded-xl border ' + statusClass;
      healthStatus.innerHTML = `
        <div class="flex items-center gap-2 ${headerColor} font-bold mb-3">
          ${headerIcon}
          ${headerText}
        </div>
        <ul class="space-y-2 text-sm">
          ${checksHtml}
        </ul>
        ${savedPixelId ? '<p class="mt-3 text-xs text-gray-600">Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø­ÙÙˆØ¸: <code class="bg-gray-200 px-2 py-1 rounded">' + savedPixelId + '</code></p>' : ''}
      `;
    }
    
    function showPixelStatus(type, message) {
      const statusEl = document.getElementById('pixelStatus');
      statusEl.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800');
      
      if (type === 'success') {
        statusEl.className = 'p-4 rounded-xl bg-green-100 text-green-800 flex items-center gap-2';
        statusEl.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>' + message;
      } else if (type === 'error') {
        statusEl.className = 'p-4 rounded-xl bg-red-100 text-red-800 flex items-center gap-2';
        statusEl.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>' + message;
      } else {
        statusEl.className = 'p-4 rounded-xl bg-blue-100 text-blue-800 flex items-center gap-2';
        statusEl.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>' + message;
      }
      
      setTimeout(() => {
        statusEl.classList.add('hidden');
      }, 5000);
    }
    
    // =====================================================
    // ANALYTICS FUNCTIONS
    // =====================================================
    
    // Refresh main site analytics
    function refreshMainSiteAnalytics() {
      try {
        const events = JSON.parse(localStorage.getItem('alzain_pixel_events') || '[]');
        const visitorId = localStorage.getItem('alzain_visitor_id') || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
        
        document.getElementById('mainSiteEventsCount').textContent = events.length;
        document.getElementById('mainSiteVisitors').textContent = visitorId.substring(0, 20) + '...';
        
        if (events.length > 0) {
          const lastEvent = events[events.length - 1];
          const eventTime = new Date(lastEvent.timestamp).toLocaleString('ar-IQ', {
            day: '2-digit',
            month: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
          document.getElementById('mainSiteLastEvent').textContent = lastEvent.event_name + ' - ' + eventTime;
        } else {
          document.getElementById('mainSiteLastEvent').textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø«';
        }
        
        refreshCombinedEvents();
        showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ', 'success');
      } catch (e) {
        console.error('Error refreshing main site analytics:', e);
        showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
      }
    }
    
    // Refresh admin panel analytics
    function refreshAdminAnalytics() {
      try {
        const events = JSON.parse(localStorage.getItem('alzain_admin_pixel_events') || '[]');
        const loginCount = localStorage.getItem('alzain_admin_login_count') || '0';
        
        document.getElementById('adminEventsCount').textContent = events.length;
        document.getElementById('adminLoginCount').textContent = loginCount;
        
        if (events.length > 0) {
          const lastEvent = events[events.length - 1];
          const eventTime = new Date(lastEvent.timestamp).toLocaleString('ar-IQ', {
            day: '2-digit',
            month: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
          document.getElementById('adminLastEvent').textContent = lastEvent.event_name + ' - ' + eventTime;
        } else {
          document.getElementById('adminLastEvent').textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø«';
        }
        
        refreshCombinedEvents();
        showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©', 'success');
      } catch (e) {
        console.error('Error refreshing admin analytics:', e);
        showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
      }
    }
    
    // Refresh combined events list
    function refreshCombinedEvents() {
      try {
        const mainEvents = JSON.parse(localStorage.getItem('alzain_pixel_events') || '[]');
        const adminEvents = JSON.parse(localStorage.getItem('alzain_admin_pixel_events') || '[]');
        
        // Combine and sort by timestamp
        const allEvents = [
          ...mainEvents.map(e => ({ ...e, source: 'main' })),
          ...adminEvents.map(e => ({ ...e, source: 'admin' }))
        ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 10);
        
        const listEl = document.getElementById('recentEventsList');
        
        if (allEvents.length === 0) {
          listEl.innerHTML = '<p class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø« Ù…Ø³Ø¬Ù„Ø©</p>';
          return;
        }
        
        listEl.innerHTML = allEvents.map(event => {
          const sourceColor = event.source === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700';
          const sourceLabel = event.source === 'admin' ? 'Ø¥Ø¯Ø§Ø±Ø©' : 'Ù…ÙˆÙ‚Ø¹';
          const eventTime = new Date(event.timestamp).toLocaleString('ar-IQ', {
            day: '2-digit',
            month: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          });
          
          return `
            <div class="p-3 bg-white rounded-lg border border-gray-200">
              <div class="flex justify-between items-start mb-1">
                <span class="font-bold text-gray-900">${event.event_name}</span>
                <span class="${sourceColor} px-2 py-0.5 rounded text-xs font-bold">${sourceLabel}</span>
              </div>
              <p class="text-gray-600 text-xs mb-1">${eventTime}</p>
              <p class="text-gray-500 text-xs font-mono">${event.event_id}</p>
            </div>
          `;
        }).join('');
      } catch (e) {
        console.error('Error refreshing events list:', e);
      }
    }
    
    // Export analytics data
    function exportAnalyticsData() {
      try {
        const mainEvents = JSON.parse(localStorage.getItem('alzain_pixel_events') || '[]');
        const adminEvents = JSON.parse(localStorage.getItem('alzain_admin_pixel_events') || '[]');
        const visitorId = localStorage.getItem('alzain_visitor_id');
        const visitCount = localStorage.getItem('alzain_visit_count');
        const adminUserId = localStorage.getItem('alzain_admin_user_id');
        const adminLoginCount = localStorage.getItem('alzain_admin_login_count');
        
        const analyticsData = {
          export_date: new Date().toISOString(),
          main_site: {
            visitor_id: visitorId,
            visit_count: parseInt(visitCount || '0'),
            total_events: mainEvents.length,
            events: mainEvents
          },
          admin_panel: {
            admin_user_id: adminUserId,
            login_count: parseInt(adminLoginCount || '0'),
            total_events: adminEvents.length,
            events: adminEvents
          }
        };
        
        const blob = new Blob([JSON.stringify(analyticsData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `alzain-analytics-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        showNotification('ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        
        // Track export action
        trackAdminDataAction('export_analytics');
      } catch (e) {
        console.error('Error exporting analytics:', e);
        showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
      }
    }
    
    // Clear all analytics
    function clearAllAnalytics() {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
        try {
          localStorage.removeItem('alzain_pixel_events');
          localStorage.removeItem('alzain_admin_pixel_events');
          
          document.getElementById('mainSiteEventsCount').textContent = '0';
          document.getElementById('adminEventsCount').textContent = '0';
          document.getElementById('mainSiteLastEvent').textContent = '-';
          document.getElementById('adminLastEvent').textContent = '-';
          document.getElementById('recentEventsList').innerHTML = '<p class="text-gray-500 text-center py-4">ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</p>';
          
          showNotification('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØªØ¨Ø¹', 'success');
        } catch (e) {
          console.error('Error clearing analytics:', e);
          showNotification('Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        }
      }
    }
    
    // =============================================
    // AI SETTINGS FUNCTIONS
    // =============================================
    
    // Load AI API key on init
    function loadAiSettings() {
      const savedKey = localStorage.getItem('alzain_ai_api_key');
      if (savedKey) {
        document.getElementById('aiApiKey').value = savedKey;
      }
    }
    
    // Save AI API key
    function saveAiApiKey() {
      const apiKey = document.getElementById('aiApiKey').value.trim();
      if (!apiKey) {
        showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ API', 'error');
        return;
      }
      
      localStorage.setItem('alzain_ai_api_key', apiKey);
      showNotification('ØªÙ… Ø­ÙØ¸ Ù…ÙØªØ§Ø­ API Ø¨Ù†Ø¬Ø§Ø­', 'success');
      
      const statusDiv = document.getElementById('aiApiStatus');
      statusDiv.className = 'mt-3 p-4 rounded-xl bg-green-50 text-green-800';
      statusDiv.innerHTML = '<div class="flex items-center gap-2"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙØªØ§Ø­</div>';
      statusDiv.classList.remove('hidden');
    }
    
    // Toggle AI key visibility
    function toggleAiKeyVisibility() {
      const input = document.getElementById('aiApiKey');
      const isPassword = input.type === 'password';
      input.type = isPassword ? 'text' : 'password';
    }
    
    // Test AI connection
    async function testAiConnection() {
      const apiKey = document.getElementById('aiApiKey').value.trim();
      if (!apiKey) {
        showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ API Ø£ÙˆÙ„Ø§Ù‹', 'error');
        return;
      }
      
      const statusDiv = document.getElementById('aiApiStatus');
      statusDiv.className = 'mt-3 p-4 rounded-xl bg-blue-50 text-blue-800';
      statusDiv.innerHTML = '<div class="flex items-center gap-2"><svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M4 12a8 8 0 018-8"/></svg> Ø¬Ø§Ø±Ù Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„...</div>';
      statusDiv.classList.remove('hidden');
      
      // Detect API type and test accordingly
      let testResult = { success: false, provider: 'unknown', message: '' };
      
      try {
        // Test Google Gemini API (keys start with AIza) - using v1 stable endpoint
        if (apiKey.startsWith('AIza')) {
          statusDiv.innerHTML = '<div class="flex items-center gap-2"><svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M4 12a8 8 0 018-8"/></svg> Ø§Ø®ØªØ¨Ø§Ø± Google Gemini...</div>';
          
          const response = await fetch(`https://generativelanguage.googleapis.com/v1/models?key=${apiKey}`, {
            method: 'GET'
          });
          
          if (response.ok) {
            const data = await response.json();
            const models = data.models?.map(m => m.name.split('/').pop()).slice(0, 3).join(', ') || 'Gemini';
            testResult = { success: true, provider: 'Google Gemini', message: `Ù…ØªØµÙ„ - Ø§Ù„Ù†Ù…Ø§Ø°Ø¬: ${models}` };
          } else {
            const error = await response.json().catch(() => ({}));
            testResult = { success: false, provider: 'Google Gemini', message: error.error?.message || `Ø®Ø·Ø£: ${response.status}` };
          }
        }
        // Test OpenAI API (keys start with sk-)
        else if (apiKey.startsWith('sk-')) {
          statusDiv.innerHTML = '<div class="flex items-center gap-2"><svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M4 12a8 8 0 018-8"/></svg> Ø§Ø®ØªØ¨Ø§Ø± OpenAI...</div>';
          
          const response = await fetch('https://api.openai.com/v1/models', {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${apiKey}`
            }
          });
          
          if (response.ok) {
            testResult = { success: true, provider: 'OpenAI', message: 'Ù…ØªØµÙ„ Ø¨Ù€ OpenAI GPT-4 Vision' };
          } else {
            const error = await response.json().catch(() => ({}));
            testResult = { success: false, provider: 'OpenAI', message: error.error?.message || `Ø®Ø·Ø£: ${response.status}` };
          }
        }
        // Test Stability AI API
        else if (apiKey.length > 30) {
          statusDiv.innerHTML = '<div class="flex items-center gap-2"><svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M4 12a8 8 0 018-8"/></svg> Ø§Ø®ØªØ¨Ø§Ø± Stability AI...</div>';
          
          const response = await fetch('https://api.stability.ai/v1/user/account', {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${apiKey}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            testResult = { success: true, provider: 'Stability AI', message: `Ù…ØªØµÙ„ - Ø§Ù„Ø±ØµÙŠØ¯: ${data.credits?.toFixed(2) || 'N/A'} credits` };
          } else {
            const error = await response.json().catch(() => ({}));
            testResult = { success: false, provider: 'Stability AI', message: error.message || `Ø®Ø·Ø£: ${response.status}` };
          }
        }
        // Generic test - assume it's valid if length is reasonable
        else if (apiKey.length >= 20) {
          testResult = { success: true, provider: 'Custom API', message: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙØªØ§Ø­ - Ø³ÙŠØªÙ… Ø§Ø®ØªØ¨Ø§Ø±Ù‡ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…' };
        } else {
          testResult = { success: false, provider: 'Unknown', message: 'Ù…ÙØªØ§Ø­ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹' };
        }
        
      } catch (error) {
        console.error('API Test Error:', error);
        // Network error - but key format looks valid
        if (apiKey.length >= 20) {
          testResult = { success: true, provider: 'API', message: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙØªØ§Ø­ - Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ (Ø®Ø·Ø£ Ø´Ø¨ÙƒØ©)' };
        } else {
          testResult = { success: false, provider: 'Unknown', message: error.message || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„' };
        }
      }
      
      // Show result
      if (testResult.success) {
        statusDiv.className = 'mt-3 p-4 rounded-xl bg-green-50 text-green-800';
        statusDiv.innerHTML = `<div class="flex items-center gap-2">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          <div>
            <strong>âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ø§Ø¬Ø­!</strong><br>
            <span class="text-sm opacity-80">${testResult.provider}: ${testResult.message}</span>
          </div>
        </div>`;
        showNotification('Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ø§Ø¬Ø­', 'success');
      } else {
        statusDiv.className = 'mt-3 p-4 rounded-xl bg-red-50 text-red-800';
        statusDiv.innerHTML = `<div class="flex items-center gap-2">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
          <div>
            <strong>âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„</strong><br>
            <span class="text-sm opacity-80">${testResult.message}</span>
          </div>
        </div>`;
        showNotification('ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
      }
    }
    
    // Refresh AI statistics
    function refreshAiStats() {
      try {
        const attempts = JSON.parse(localStorage.getItem('alzain_ai_attempts') || '[]');
        const today = new Date().toDateString();
        
        // Total attempts
        document.getElementById('aiTotalAttempts').textContent = attempts.length;
        
        // Unique users (by visitor ID)
        const uniqueUsers = new Set(attempts.map(a => a.visitorId || a.sessionId || 'unknown'));
        document.getElementById('aiUniqueUsers').textContent = uniqueUsers.size;
        
        // Today's attempts
        const todayAttempts = attempts.filter(a => new Date(a.timestamp).toDateString() === today);
        document.getElementById('aiTodayAttempts').textContent = todayAttempts.length;
        
        // Popular products
        const productCounts = {};
        attempts.forEach(a => {
          if (a.productName) {
            productCounts[a.productName] = (productCounts[a.productName] || 0) + 1;
          }
        });
        
        const sortedProducts = Object.entries(productCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);
        
        const popularProductsDiv = document.getElementById('aiPopularProducts');
        if (sortedProducts.length > 0) {
          popularProductsDiv.innerHTML = sortedProducts.map(([name, count], index) => `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
              <div class="flex items-center gap-3">
                <span class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-white ${index === 0 ? 'bg-amber-500' : index === 1 ? 'bg-gray-400' : index === 2 ? 'bg-amber-700' : 'bg-gray-300'}">${index + 1}</span>
                <span class="font-bold text-gray-800">${name}</span>
              </div>
              <span class="px-3 py-1 rounded-full text-sm font-bold" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1)); color: #8B5CF6;">${count} Ù…Ø­Ø§ÙˆÙ„Ø©</span>
            </div>
          `).join('');
        } else {
          popularProductsDiv.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</p>';
        }
        
        // Popular colors
        const colorCounts = {};
        attempts.forEach(a => {
          if (a.color) {
            colorCounts[a.color] = colorCounts[a.color] || { count: 0, name: a.colorName || a.color };
            colorCounts[a.color].count++;
          }
        });
        
        const sortedColors = Object.entries(colorCounts)
          .sort((a, b) => b[1].count - a[1].count)
          .slice(0, 8);
        
        const popularColorsDiv = document.getElementById('aiPopularColors');
        if (sortedColors.length > 0) {
          popularColorsDiv.innerHTML = sortedColors.map(([color, data]) => `
            <div class="flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-xl">
              <div class="w-6 h-6 rounded-full border-2 border-white shadow" style="background: ${color};"></div>
              <span class="text-sm font-bold">${data.name}</span>
              <span class="text-xs text-gray-500">(${data.count})</span>
            </div>
          `).join('');
        } else {
          popularColorsDiv.innerHTML = '<p class="text-gray-500 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</p>';
        }
        
        // Recent attempts
        const recentAttempts = attempts.slice(-10).reverse();
        const recentAttemptsDiv = document.getElementById('aiRecentAttempts');
        if (recentAttempts.length > 0) {
          recentAttemptsDiv.innerHTML = recentAttempts.map(a => {
            const date = new Date(a.timestamp);
            const timeStr = date.toLocaleTimeString('ar-IQ', { hour: '2-digit', minute: '2-digit' });
            const dateStr = date.toLocaleDateString('ar-IQ');
            return `
              <div class="flex items-center justify-between py-2 border-b border-gray-200 last:border-0">
                <div class="flex items-center gap-3">
                  <div class="w-4 h-4 rounded-full" style="background: ${a.color || '#ccc'};"></div>
                  <span class="font-medium text-sm">${a.productName || 'Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</span>
                </div>
                <span class="text-xs text-gray-500">${dateStr} - ${timeStr}</span>
              </div>
            `;
          }).join('');
        } else {
          recentAttemptsDiv.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¨Ø¹Ø¯</p>';
        }
        
        showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª AI', 'success');
      } catch (e) {
        console.error('Error refreshing AI stats:', e);
        showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
      }
    }
    
    // Export AI statistics
    function exportAiStats() {
      try {
        const attempts = JSON.parse(localStorage.getItem('alzain_ai_attempts') || '[]');
        const apiKey = localStorage.getItem('alzain_ai_api_key');
        
        const exportData = {
          exportDate: new Date().toISOString(),
          apiKeyConfigured: !!apiKey,
          totalAttempts: attempts.length,
          attempts: attempts
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `alzain-ai-stats-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        showNotification('ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª AI Ø¨Ù†Ø¬Ø§Ø­', 'success');
      } catch (e) {
        console.error('Error exporting AI stats:', e);
        showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±', 'error');
      }
    }
    
    // Clear AI statistics
    function clearAiStats() {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª AIØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
        try {
          localStorage.removeItem('alzain_ai_attempts');
          
          document.getElementById('aiTotalAttempts').textContent = '0';
          document.getElementById('aiUniqueUsers').textContent = '0';
          document.getElementById('aiTodayAttempts').textContent = '0';
          document.getElementById('aiPopularProducts').innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
          document.getElementById('aiPopularColors').innerHTML = '<p class="text-gray-500 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
          document.getElementById('aiRecentAttempts').innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª</p>';
          
          showNotification('ØªÙ… Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª AI', 'success');
        } catch (e) {
          console.error('Error clearing AI stats:', e);
          showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø³Ø­', 'error');
        }
      }
    }
    
    // =============================================
    // SECURITY FUNCTIONS - Password Change & Logout
    // =============================================
    
    // SHA-256 Hash Function
    async function hashPassword(password) {
      const msgBuffer = new TextEncoder().encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }
    
    // Check password strength
    function checkPasswordStrength(password) {
      const strengthDiv = document.getElementById('passwordStrength');
      const strengthText = document.getElementById('passwordStrengthText');
      const bars = strengthDiv.querySelectorAll('div > div');
      
      if (password.length === 0) {
        strengthDiv.classList.add('hidden');
        return;
      }
      
      strengthDiv.classList.remove('hidden');
      let strength = 0;
      
      if (password.length >= 8) strength++;
      if (password.length >= 12) strength++;
      if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
      if (/[0-9]/.test(password)) strength++;
      if (/[^a-zA-Z0-9]/.test(password)) strength++;
      
      bars.forEach((bar, index) => {
        bar.className = 'h-1 flex-1 rounded';
        if (index < strength) {
          if (strength <= 2) bar.classList.add('bg-red-500');
          else if (strength <= 3) bar.classList.add('bg-yellow-500');
          else bar.classList.add('bg-green-500');
        } else {
          bar.classList.add('bg-gray-200');
        }
      });
      
      const strengthNames = ['Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹', 'Ø¶Ø¹ÙŠÙØ©', 'Ù…ØªÙˆØ³Ø·Ø©', 'Ø¬ÙŠØ¯Ø©', 'Ù‚ÙˆÙŠØ©'];
      const strengthColors = ['text-red-600', 'text-orange-600', 'text-yellow-600', 'text-blue-600', 'text-green-600'];
      strengthText.textContent = 'Ù‚ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: ' + strengthNames[strength - 1];
      strengthText.className = 'text-xs mt-1 font-bold ' + strengthColors[strength - 1];
    }
    
    // Change password
    async function changePassword() {
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const statusDiv = document.getElementById('passwordChangeStatus');
      
      // Validation
      if (!currentPassword || !newPassword || !confirmPassword) {
        statusDiv.className = 'p-3 rounded-xl text-sm text-center bg-red-50 text-red-700';
        statusDiv.textContent = 'âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„';
        statusDiv.classList.remove('hidden');
        return;
      }
      
      if (newPassword.length < 8) {
        statusDiv.className = 'p-3 rounded-xl text-sm text-center bg-red-50 text-red-700';
        statusDiv.textContent = 'âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„';
        statusDiv.classList.remove('hidden');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        statusDiv.className = 'p-3 rounded-xl text-sm text-center bg-red-50 text-red-700';
        statusDiv.textContent = 'âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©';
        statusDiv.classList.remove('hidden');
        return;
      }
      
      // Check current password
      const currentHash = await hashPassword(currentPassword);
      const defaultHash = await hashPassword('admin123');
      const storedHash = localStorage.getItem('alzain_admin_password') || defaultHash;
      
      if (currentHash !== storedHash) {
        statusDiv.className = 'p-3 rounded-xl text-sm text-center bg-red-50 text-red-700';
        statusDiv.textContent = 'âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
        statusDiv.classList.remove('hidden');
        return;
      }
      
      // Save new password
      const newHash = await hashPassword(newPassword);
      localStorage.setItem('alzain_admin_password', newHash);
      
      statusDiv.className = 'p-3 rounded-xl text-sm text-center bg-green-50 text-green-700';
      statusDiv.innerHTML = `
        <svg class="w-5 h-5 inline-block ml-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
          <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!
      `;
      statusDiv.classList.remove('hidden');
      
      // Clear inputs
      document.getElementById('currentPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
      document.getElementById('passwordStrength').classList.add('hidden');
      
      showNotification('ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
    }
    
    // Logout function
    function logout() {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
        localStorage.removeItem('alzain_admin_session');
        localStorage.removeItem('alzain_session_expiry');
        window.location.href = 'login.html';
      }
    }
    
    // Auto logout on inactivity
    let inactivityTimer;
    function resetInactivityTimer() {
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => {
        alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø³Ø¨Ø¨ Ø¹Ø¯Ù… Ø§Ù„Ù†Ø´Ø§Ø·');
        logout();
      }, 30 * 60 * 1000); // 30 minutes
    }
    
    // Track activity
    document.addEventListener('mousemove', resetInactivityTimer);
    document.addEventListener('keypress', resetInactivityTimer);
    document.addEventListener('click', resetInactivityTimer);
    document.addEventListener('scroll', resetInactivityTimer);
    
    // Password strength checker on input
    document.addEventListener('DOMContentLoaded', () => {
      const newPasswordInput = document.getElementById('newPassword');
      if (newPasswordInput) {
        newPasswordInput.addEventListener('input', (e) => {
          checkPasswordStrength(e.target.value);
        });
      }
      
      // Start inactivity timer
      resetInactivityTimer();
    });
    
    // Show notification helper
    function showNotification(message, type) {
      const notification = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
      notification.className = `fixed top-6 left-1/2 transform -translate-x-1/2 ${bgColor} text-white px-6 py-3 rounded-xl font-bold shadow-lg z-50`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Add product modal
    function showAddProduct() {
      document.getElementById('addProductModal').classList.remove('hidden');
    }

    function closeAddProduct() {
      document.getElementById('addProductModal').classList.add('hidden');
      document.getElementById('addProductForm').reset();
      const preview = document.getElementById('imagePreview');
      preview.innerHTML = '';
      delete preview.dataset.compressedImages;
      delete preview.dataset.starredIndex;
    }

    // Add product
    document.getElementById('addProductForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const preview = document.getElementById('imagePreview');
      const compressedImagesData = preview.dataset.compressedImages;
      
      if (!compressedImagesData) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ± Ù„Ù„Ù…Ù†ØªØ¬');
        return;
      }
      
      const imageData = JSON.parse(compressedImagesData);
      const starredIndex = parseInt(preview.dataset.starredIndex || '0');
      
      // Reorder images to put starred image first
      const reorderedImages = [...imageData];
      if (starredIndex > 0 && starredIndex < reorderedImages.length) {
        const starredImage = reorderedImages.splice(starredIndex, 1)[0];
        reorderedImages.unshift(starredImage);
      }
      
      const oldPrice = document.getElementById('productOldPrice').value;
      const newProduct = {
        id: nextProductId++,
        name: document.getElementById('productName').value,
        collection: document.getElementById('productCollection').value,
        description: document.getElementById('productDescription').value,
        price: parseInt(document.getElementById('productPrice').value),
        oldPrice: oldPrice ? parseInt(oldPrice) : null,
        images: reorderedImages
      };

      products.push(newProduct);
      saveData();
      closeAddProduct();
      updateStats();
      loadProducts();
      
      // Track admin action
      trackAdminProductAction('add', newProduct);
    });

    // Edit product modal
    function editProduct(id) {
      const product = products.find(p => p.id === id);
      if (!product) return;

      document.getElementById('editProductId').value = product.id;
      document.getElementById('editProductName').value = product.name;
      document.getElementById('editProductCollection').value = product.collection;
      document.getElementById('editProductDescription').value = product.description || '';
      document.getElementById('editProductPrice').value = product.price;
      document.getElementById('editProductOldPrice').value = product.oldPrice || '';
      document.getElementById('editProductModal').classList.remove('hidden');
    }

    function closeEditProduct() {
      document.getElementById('editProductModal').classList.add('hidden');
      document.getElementById('editProductForm').reset();
    }

    // Edit product
    document.getElementById('editProductForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const id = parseInt(document.getElementById('editProductId').value);
      const productIndex = products.findIndex(p => p.id === id);
      
      if (productIndex !== -1) {
        const oldPrice = document.getElementById('editProductOldPrice').value;
        products[productIndex] = {
          ...products[productIndex],
          name: document.getElementById('editProductName').value,
          collection: document.getElementById('editProductCollection').value,
          description: document.getElementById('editProductDescription').value,
          price: parseInt(document.getElementById('editProductPrice').value),
          oldPrice: oldPrice ? parseInt(oldPrice) : null
        };

        saveData();
        closeEditProduct();
        loadProducts();
        
        // Track admin action
        trackAdminProductAction('edit', products[productIndex]);
      }
    });

    // Delete product
    // Delete product (move to recycle bin)
    function deleteProduct(id) {
      if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ')) return;
      
      const product = products.find(p => p.id === id);
      if (product) {
        // Add deletion timestamp
        product.deletedAt = new Date().toISOString();
        deletedProducts.push(product);
        products = products.filter(p => p.id !== id);
        saveData();
        updateStats();
        loadProducts();
        
        // Track admin action
        trackAdminProductAction('delete', product);
        
        // Show notification
        const trashIcon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"/></svg>';
        showNotification(trashIcon + ' ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª');
      }
    }

    // Load recycle bin
    function loadRecycleBin() {
      const recycleList = document.getElementById('recycleList');
      
      if (deletedProducts.length === 0) {
        recycleList.innerHTML = `
          <div class="col-span-3 card rounded-2xl p-12 text-center">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mx-auto mb-4 text-gray-400">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
              <line x1="10" y1="11" x2="10" y2="17"/>
              <line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
            <p class="text-gray-600 text-lg">Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª ÙØ§Ø±ØºØ©</p>
          </div>
        `;
        return;
      }

      recycleList.innerHTML = deletedProducts.map(product => {
        const deletedDate = new Date(product.deletedAt).toLocaleDateString('ar-EG');
        return `
          <div class="card rounded-2xl p-6 opacity-75">
            <div class="aspect-video bg-gradient-to-br from-gray-500/10 to-gray-600/5 rounded-xl mb-4 flex items-center justify-center overflow-hidden">
              ${product.images && product.images.length > 0 ? `<img src="${product.images[0]}" class="w-full h-full object-cover grayscale">` : '<div class="text-6xl grayscale">ğŸ›‹ï¸</div>'}
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">${product.name}</h3>
            <p class="text-gray-600 text-sm mb-2">${product.collection}</p>
            <p class="text-gray-500 text-xs mb-3">Ø­ÙØ°Ù ÙÙŠ: ${deletedDate}</p>
            <div class="mb-4">
              ${product.oldPrice ? `<p class="text-lg font-bold text-red-500 line-through mb-1">${product.oldPrice.toLocaleString()} Ø¯ÙŠÙ†Ø§Ø±</p>` : ''}
              <p class="text-2xl font-black text-gray-400">${product.price.toLocaleString()} Ø¯ÙŠÙ†Ø§Ø±</p>
            </div>
            <div class="flex gap-2">
              <button onclick="restoreProduct(${product.id})" class="flex-1 bg-green-50 text-green-600 px-4 py-2 rounded-xl text-sm hover:bg-green-100 transition font-bold inline-flex items-center justify-center gap-2">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 11V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h6"/><path d="M16 19l4 4m0-4l-4 4"/><circle cx="18" cy="18" r="3"/></svg>
                Ø§Ø³ØªØ¹Ø§Ø¯Ø©
              </button>
              <button onclick="permanentDeleteProduct(${product.id})" class="flex-1 bg-red-50 text-red-600 px-4 py-2 rounded-xl text-sm hover:bg-red-100 transition font-bold inline-flex items-center justify-center gap-2">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Restore product from recycle bin
    function restoreProduct(id) {
      const product = deletedProducts.find(p => p.id === id);
      if (!product) return;
      
      // Temporarily add product back
      delete product.deletedAt;
      const tempProducts = [...products, product];
      const tempDeletedProducts = deletedProducts.filter(p => p.id !== id);
      
      // Try to save
      const originalProducts = [...products];
      const originalDeleted = [...deletedProducts];
      
      products = tempProducts;
      deletedProducts = tempDeletedProducts;
      
      const success = saveData();
      
      if (!success) {
        // Restore original state
        products = originalProducts;
        deletedProducts = originalDeleted;
        
        alert('âš  ØªØ¬Ø§ÙˆØ²Øª Ø³Ø¹Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ†!\n\nÙ„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡:\n1. Ø­Ø°Ù Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©\n2. Ø£Ùˆ Ø¥ÙØ±Ø§Øº Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰\n3. Ø£Ùˆ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø³Ù„Ø© Ù„ØªÙˆÙÙŠØ± Ù…Ø³Ø§Ø­Ø©');
        return;
      }
      
      updateStats();
      loadRecycleBin();
      const checkIcon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>';
      showNotification(checkIcon + ' ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­');
    }

    // Permanently delete product
    function permanentDeleteProduct(id) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!')) return;
      
      deletedProducts = deletedProducts.filter(p => p.id !== id);
      saveData();
      loadRecycleBin();
      const trashIcon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"/></svg>';
      showNotification(trashIcon + ' ØªÙ… Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ');
    }

    // Empty recycle bin
    function emptyRecycleBin() {
      if (deletedProducts.length === 0) {
        alert('Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª ÙØ§Ø±ØºØ© Ø¨Ø§Ù„ÙØ¹Ù„');
        return;
      }
      
      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${deletedProducts.length} Ù…Ù†ØªØ¬ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!`)) return;
      
      deletedProducts = [];
      saveData();
      loadRecycleBin();
      const trashIcon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"/></svg>';
      showNotification(trashIcon + ' ØªÙ… Ø¥ÙØ±Ø§Øº Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª');
    }

    // Show notification helper
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'fixed top-6 left-1/2 transform -translate-x-1/2 gold-gradient text-black px-6 py-3 rounded-xl font-bold shadow-lg z-50';
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Update order status
    function updateOrderStatus(orderId, status) {
      const order = orders.find(o => o.id === orderId);
      if (order) {
        order.status = status;
        saveData();
        updateStats();
        loadOrders();
        
        // Track admin action
        trackAdminOrderAction('update_status', order);
      }
    }

    // Delete order
    function deleteOrder(orderId) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ')) return;
      
      const order = orders.find(o => o.id === orderId);
      orders = orders.filter(o => o.id !== orderId);
      saveData();
      updateStats();
      loadOrders();
      
      // Track admin action
      if (order) trackAdminOrderAction('delete', order);
    }

    // Category Management
    let categories = ['Ø±Ù…Ø³ÙŠØ³', 'Ø±ÙˆÙŠØ§Ù„', 'Ø£Ø®Ø±Ù‰'];
    let categoryFormContext = 'add'; // 'add' or 'edit'

    // Load categories from localStorage
    function loadCategories() {
      const savedCategories = localStorage.getItem('alzain_categories');
      if (savedCategories) {
        categories = JSON.parse(savedCategories);
      }
      updateCategorySelects();
    }

    // Save categories to localStorage
    function saveCategories() {
      localStorage.setItem('alzain_categories', JSON.stringify(categories));
    }
    
    // =====================================================
    // DATA EXPORT/IMPORT FUNCTIONS
    // =====================================================
    
    // Export all data
    function exportData() {
      try {
        const exportData = {
          products: products,
          orders: orders,
          deletedProducts: deletedProducts,
          categories: categories,
          nextProductId: nextProductId,
          nextOrderId: nextOrderId,
          exportDate: new Date().toISOString()
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `alzain-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        showNotification('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
        
        // Track admin action
        trackAdminDataAction('export');
      } catch (e) {
        console.error('Error exporting data:', e);
        alert('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + e.message);
      }
    }
    
    // Import data
    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          if (!confirm('Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
            event.target.value = '';
            return;
          }
          
          // Restore data
          if (data.products) products = data.products;
          if (data.orders) orders = data.orders;
          if (data.deletedProducts) deletedProducts = data.deletedProducts;
          if (data.categories) categories = data.categories;
          if (data.nextProductId) nextProductId = data.nextProductId;
          if (data.nextOrderId) nextOrderId = data.nextOrderId;
          
          saveData();
          saveCategories();
          updateStats();
          loadProducts();
          loadOrders();
          
          showNotification('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
          event.target.value = '';
          
          // Track admin action
          trackAdminDataAction('import');
        } catch (e) {
          console.error('Error importing data:', e);
          alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + e.message);
          event.target.value = '';
        }
      };
      reader.readAsText(file);
    }

    // Update all category select dropdowns
    function updateCategorySelects() {
      const addSelect = document.getElementById('productCollection');
      const editSelect = document.getElementById('editProductCollection');
      
      // Store current values
      const addValue = addSelect ? addSelect.value : '';
      const editValue = editSelect ? editSelect.value : '';
      
      // Update add product dropdown
      if (addSelect) {
        addSelect.innerHTML = categories.map(cat => 
          `<option value="${cat}">${cat}</option>`
        ).join('');
        if (addValue && categories.includes(addValue)) {
          addSelect.value = addValue;
        }
      }
      
      // Update edit product dropdown
      if (editSelect) {
        editSelect.innerHTML = categories.map(cat => 
          `<option value="${cat}">${cat}</option>`
        ).join('');
        if (editValue && categories.includes(editValue)) {
          editSelect.value = editValue;
        }
      }
    }

    // Open create category modal
    function openCreateCategory(context) {
      categoryFormContext = context;
      document.getElementById('createCategoryModal').classList.remove('hidden');
      document.getElementById('newCategoryName').focus();
    }

    // Close create category modal
    function closeCreateCategory() {
      document.getElementById('createCategoryModal').classList.add('hidden');
      document.getElementById('createCategoryForm').reset();
    }

    // Listen for new orders from main website
    window.addEventListener('storage', (e) => {
      if (e.key === 'alzain_orders' || e.key === 'alzain_products') {
        autoRefreshData();
      }
    });

    // Auto-refresh function
    async function autoRefreshData() {
      if (!currentUser) return;
      
      try {
        // Show refreshing indicator
        const refreshIndicator = document.getElementById('lastRefresh');
        if (refreshIndicator) {
          refreshIndicator.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="inline animate-spin"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0118.8-4.3M22 12.5a10 10 0 01-18.8 4.2"/></svg> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...';
          refreshIndicator.className = 'text-xs text-blue-600 font-bold';
        }
        
        await loadData();
        updateStats();
        
        // Refresh current visible tab
        const productsVisible = !document.getElementById('productsContent').classList.contains('hidden');
        const ordersVisible = !document.getElementById('ordersContent').classList.contains('hidden');
        const recycleVisible = !document.getElementById('recycleContent').classList.contains('hidden');
        
        if (productsVisible) {
          loadProducts();
        } else if (ordersVisible) {
          loadOrders();
        } else if (recycleVisible) {
          loadRecycleBin();
        }
        
        // Update refresh indicator
        if (refreshIndicator) {
          const now = new Date();
          const timeStr = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
          refreshIndicator.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="inline"><polyline points="20 6 9 17 4 12"/></svg> Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${timeStr}`;
          refreshIndicator.className = 'text-xs text-green-600';
          
          // Fade back to gray after 2 seconds
          setTimeout(() => {
            refreshIndicator.className = 'text-xs text-gray-500';
          }, 2000);
        }
      } catch (error) {
        console.error('Auto-refresh error:', error);
        const refreshIndicator = document.getElementById('lastRefresh');
        if (refreshIndicator) {
          refreshIndicator.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="inline"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg> Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«';
          refreshIndicator.className = 'text-xs text-red-600';
        }
      }
    }

    // Auto-refresh every 10 seconds
    setInterval(async () => {
      await autoRefreshData();
    }, 10000);

    // Also refresh when tab becomes visible
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        autoRefreshData();
      }
    });
  </script>
</body>
</html>
